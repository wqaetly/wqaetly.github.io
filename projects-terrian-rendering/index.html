<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>ProjectS中的地形系统-Terrian Rendering | 登峰造极者，殊途亦同归。</title><meta name="author" content="烟雨迷离半世殇"><meta name="copyright" content="烟雨迷离半世殇"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="地形系统思路来自 ProjectS中的GPU Driven 架构 首先明确ProjectS的世界大小，目前暂定整个世界面积为 20.48km * 20.48km ，实际上可以再大很多，但考虑到资源量级以及对于世界内容的填充需要颇费心思，暂定这么大了  既然地形分了LOD，那么纹理自然也要根据LOD进行区分  LOD0的Node对应的纹理信息（高度纹理，Material Id纹理等）分辨率为128*">
<meta property="og:type" content="article">
<meta property="og:title" content="ProjectS中的地形系统-Terrian Rendering">
<meta property="og:url" content="https://www.lfzxb.top/projects-terrian-rendering/index.html">
<meta property="og:site_name" content="登峰造极者，殊途亦同归。">
<meta property="og:description" content="地形系统思路来自 ProjectS中的GPU Driven 架构 首先明确ProjectS的世界大小，目前暂定整个世界面积为 20.48km * 20.48km ，实际上可以再大很多，但考虑到资源量级以及对于世界内容的填充需要颇费心思，暂定这么大了  既然地形分了LOD，那么纹理自然也要根据LOD进行区分  LOD0的Node对应的纹理信息（高度纹理，Material Id纹理等）分辨率为128*">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/202403020046066.png!webp">
<meta property="article:published_time" content="2023-06-19T00:00:00.000Z">
<meta property="article:modified_time" content="2024-03-02T00:00:00.000Z">
<meta property="article:author" content="烟雨迷离半世殇">
<meta property="article:tag" content="GPU Driven">
<meta property="article:tag" content="图形渲染">
<meta property="article:tag" content="PCG">
<meta property="article:tag" content="Houdini">
<meta property="article:tag" content="Hi-zBuffer">
<meta property="article:tag" content="RVT">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/202403020046066.png!webp"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "ProjectS中的地形系统-Terrian Rendering",
  "url": "https://www.lfzxb.top/projects-terrian-rendering/",
  "image": "https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/202403020046066.png!webp",
  "datePublished": "2023-06-19T00:00:00.000Z",
  "dateModified": "2024-03-02T00:00:00.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "烟雨迷离半世殇",
      "url": "https://www.lfzxb.top/www.lfzxb.top"
    }
  ]
}</script><link rel="shortcut icon" href="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/AvatarAndBGs/33ec68b7fe1bb742.jpg!webp"><link rel="canonical" href="https://www.lfzxb.top/projects-terrian-rendering/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="google-site-verification" content="AhlEJ91V_L12bkwRF1ZS0BbytGCfsjqCX4GXztUluC8"><meta name="baidu-site-verification" content="iRRtEBalDiujISsN"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          const hour = new Date().getHours()
          const isNight = hour <= 6 || hour >= 8
          if (theme === undefined) isNight ? activateDarkMode() : activateLightMode()
          else theme === 'light' ? activateLightMode() : activateDarkMode()
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: 'ca-pub-7235595771604497',
  enable_page_level_ads: 'true'
});</script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-XSL6D8K8G2"></script><script>window.dataLayer = window.dataLayer || []
function gtag(){dataLayer.push(arguments)}
gtag('js', new Date())
gtag('config', 'G-XSL6D8K8G2')
btf.addGlobalFn('pjaxComplete', () => {
  gtag('config', 'G-XSL6D8K8G2', {'page_path': window.location.pathname})
}, 'google_analytics')
</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":800,"highlightFullpage":true,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"已切换为繁体中文","cht_to_chs":"已切换为简体中文","day_to_night":"已切换为深色模式","night_to_day":"已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: true,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ProjectS中的地形系统-Terrian Rendering',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/CustomIcons/iconfontformaliyun.css"><meta name="referrer" content="no-referrer-when-downgrade"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/AvatarAndBGs/33ec68b7fe1bb742.jpg!webp" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar" loading='lazy'></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">246</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">188</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">56</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-torii-gate"></i><span> 蓬莱仙境</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-stream"></i><span> 白驹过隙</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 包罗万象</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分朋引类</span></a></div><div class="menus_item"><a class="site-page" href="/self/"><i class="fa-fw fas fa-id-card"></i><span> 择交而友</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 一见如故</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/202403020046066.png!webp);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/202507052331881.png!webp" alt="Logo" loading='lazy'></a><a class="nav-page-title" href="/"><span class="site-name">ProjectS中的地形系统-Terrian Rendering</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-torii-gate"></i><span> 蓬莱仙境</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-stream"></i><span> 白驹过隙</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 包罗万象</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分朋引类</span></a></div><div class="menus_item"><a class="site-page" href="/self/"><i class="fa-fw fas fa-id-card"></i><span> 择交而友</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 一见如故</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">ProjectS中的地形系统-Terrian Rendering</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-06-19T00:00:00.000Z" title="发表于 2023-06-19 00:00:00">2023-06-19</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-03-02T00:00:00.000Z" title="更新于 2024-03-02 00:00:00">2024-03-02</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%9B%BE%E5%BD%A2%E6%B8%B2%E6%9F%93/">图形渲染</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%9B%BE%E5%BD%A2%E6%B8%B2%E6%9F%93/%E5%BA%94%E7%94%A8%E5%AE%9E%E6%88%98/">应用实战</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">7.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>31分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/projects-terrian-rendering/#post-comment"><span class="gitalk-comment-count"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;这篇文章已经&quot;,&quot;messageNext&quot;:&quot;天没维护了，相关内容可能已过时。&quot;,&quot;postUpdate&quot;:&quot;2024-03-02 00:00:00&quot;}" hidden=""></div><div id="postchat_postcontent"><p>地形系统思路来自 <a href="https://www.lfzxb.top/projects-gpu-driven/">ProjectS中的GPU Driven</a></p>
<h1>架构</h1>
<p>首先明确ProjectS的世界大小，目前暂定整个世界面积为 <code>20.48km * 20.48km</code> ，实际上可以再大很多，但考虑到资源量级以及对于世界内容的填充需要颇费心思，暂定这么大了</p>
<iframe id="embed_dom" name="embed_dom" frameborder="0" style="display:block;width:100%; height:500px;" src="https://www.processon.com/embed/649066e249c3ea6f151c26a0"></iframe>
<p>既然地形分了LOD，那么纹理自然也要根据LOD进行区分</p>
<ul>
<li>LOD0的Node对应的纹理信息（高度纹理，Material Id纹理等）分辨率为<code>128*128</code>，覆盖区域为<code>64m*64m</code>即一个纹素对应0.5m，已经很可以了，再高点画质就要比原神好了</li>
<li>LOD1的Node纹理分辨率为<code>128*128</code>，但覆盖区域为<code>128m*128m</code></li>
<li>LOD2的Node纹理分辨率为<code>128*128</code>，覆盖区域为<code>256m*256m</code></li>
<li>LOD3的Node纹理分辨率为<code>128*128</code>，覆盖区域为<code>512m*512m</code></li>
<li>LOD4的Node纹理分辨率为<code>128*128</code>，覆盖区域为<code>1024m*1024m</code></li>
<li>LOD5的Node纹理分辨率为<code>128*128</code>，覆盖区域为<code>2048m*2048m</code></li>
</ul>
<p>这也就意味着我们需要<code>对整个世界做六种不同覆盖区域的纹理，可以理解为Mipmap，不同的LOD Node采样不同覆盖区域面积的纹理</code>，如图所示</p>
<iframe id="embed_dom" name="embed_dom" frameborder="0" style="display:block;width:100%; height:500px;" src="https://www.processon.com/embed/6493e4d2c13b041a4c732c9a"></iframe>
<p>不同颜色代表不同LOD等级，但每个LOD都是使用的<code>128*128</code>分辨率的高度图纹理进行渲染的，这里以原分辨率8192纹理为例，需要额外再导出4096，2048，1024，512，256的贴图，才能满足所有LOD层级的渲染需求。</p>
<p>需要注意的是，<code>由于我们所有纹理都是分块流式加载的，每张纹理仅仅是128*128的，没有全分辨率的纹理，所以类似SampleLevel这种指定mip等级的API是用不了的，只能自己将相应的LOD对应纹理加载进来，由于纹理数量较多，且分辨率相同，使用Unity的TextureArray作为管理器是一个很好的选择，可以有效减少bind消耗</code></p>
<p>明确了基础的世界组成架构，接下来需要确定整个地形渲染系统的运作流程</p>
<iframe id="embed_dom" name="embed_dom" frameborder="0" style="display:block;width:100%; height:800px;" src="https://www.processon.com/embed/6493fc42516ce3025f5774cb"></iframe>
<h1>资源准备</h1>
<h2 id="Patch">Patch</h2>
<p>首先是最基础的Patch，直接在houdini拉一个8x8m，分辨率为16的grid导出fbx即可</p>
<p>有几个注意点</p>
<ul>
<li>记得在fbx的rop节点恢复原生比例（勾选Convert Units），不然导入到unity还得放大100倍</li>
<li><code>需要注意我们需要把mesh的UV处理一下，不然导出的mesh顶点是没有uv信息的</code></li>
</ul>
<p><img src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/202310292111309.png" alt="image-20231029211132984" loading='lazy'></p>
<h2 id="Height-Texture">Height Texture</h2>
<p>详情见：<a href="https://www.lfzxb.top/projects-terrian-pcg/">https://www.lfzxb.top/projects-terrian-pcg/</a></p>
<h1>CPU（一阶段）</h1>
<p>得益于ET的ECS代码结构形式，我们可以比较直观方便的对整个地形渲染系统进行架构</p>
<h2 id="Terrian-Entity">Terrian Entity</h2>
<p>整个地形的渲染通过TerrianRenderComponent进行托管，由于我们不仅需要渲染HeightField，还有RVT，Hi-Z等内容，所以结构如下：</p>
<iframe id="embed_dom" name="embed_dom" frameborder="0" style="display:block;width:100%; height:500px;" src="https://www.processon.com/embed/653e53e3295e9607603dc237"></iframe>
<h3 id="TerrianRenderComponent">TerrianRenderComponent</h3>
<p>作为整个地形渲染的基础组件，需要提供必要的信息，我们的世界大小，四叉树的数据都由此组件维护</p>
<figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TerrianRenderComponent</span> : <span class="title">Entity</span>, <span class="title">IAwake</span>, <span class="title">IDestroy</span>, <span class="title">ILateUpdate</span></span><br><span class="line">{</span><br><span class="line">    [<span class="meta">LabelText(<span class="string">"四叉树单个节点最大包含内容数"</span>)</span>] <span class="keyword">public</span> <span class="built_in">int</span> maxContentLimit = <span class="number">1</span>;</span><br><span class="line">    [<span class="meta">BoxGroup(<span class="string">"地形"</span>)</span>] [LabelText(<span class="string">"需要细分的距离"</span>)]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> distanceToSplit = <span class="number">300</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> 引用</span></span><br><span class="line"></span><br><span class="line">    [<span class="meta">BoxGroup(<span class="string">"地形"</span>)</span>] [LabelText(<span class="string">"世界大小"</span>)] <span class="keyword">public</span> <span class="built_in">int</span> worldSize = <span class="number">20480</span>;</span><br><span class="line">    [<span class="meta">BoxGroup(<span class="string">"地形"</span>)</span>] [LabelText(<span class="string">"世界"</span>)] <span class="keyword">public</span> GameObject plane;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// LOD级数，默认6级，LOD0为64m，LOD5为2048m</span></span><br><span class="line">    [<span class="meta">BoxGroup(<span class="string">"地形"</span>)</span>] [LabelText(<span class="string">"LOD级数"</span>)] <span class="keyword">public</span> <span class="built_in">int</span> lodLevelCount = <span class="number">6</span>;</span><br><span class="line">    [<span class="meta">BoxGroup(<span class="string">"地形"</span>)</span>] [LabelText(<span class="string">"指定四叉树大小"</span>)]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> quadTreeSize = <span class="number">4096</span>;</span><br><span class="line">    <span class="keyword">private</span> Vector3 m_startMovePos;</span><br><span class="line">    <span class="keyword">private</span> Vector3 m_nextTargetPos;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">    <span class="keyword">public</span> QuadTree.QuadTree terrianQuadTree;</span><br><span class="line">    <span class="keyword">public</span> List&lt;TerrianNode&gt; terrianNodes = <span class="keyword">new</span> List&lt;TerrianNode&gt;();</span><br><span class="line">    </span><br><span class="line">    [<span class="meta">LabelText(<span class="string">"绘制四叉树"</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> DebugMode;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> 剔除</span></span><br><span class="line">    <span class="keyword">public</span> Plane[] cameraFrustumPlanes = <span class="keyword">new</span> Plane[<span class="number">6</span>];</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>目前来说，TerrianRender的核心逻辑是在构建维护四叉树：</p>
<h4 id="四叉树构造">四叉树构造</h4>
<p><strong>值得注意的是，如果没有流式加载的需求，其实是不需要标准化的四叉树的，只需要将所有需要细分的节点进行4次细分即可，完全可以将四叉树的构建和剔除放在GPU加速</strong></p>
<p><strong>而如果需要流式加载，则需要构建标准四叉树，理由如下：</strong></p>
<ul>
<li>随着地形渲染需求越来越高，单个Node所涵盖的资产和数据就越大，如果全都在GPU构造和剔除，在CPU阶段我们就无法得知单个Node是否需要被用到，就需要把所有资源同步至GPU，会浪费非常多的内存和显存</li>
<li>涉及相对复杂的数据结构和数据异步交互(例如资源加载)，在GPU实现非常困难</li>
</ul>
<p>由于我们无法保证四叉树一定是一颗完全树，所以没法用数组的形式来保存节点信息，另外我们需要动态更新四叉树，所以采用指针引用的形式进行节点存储</p>
<p>四叉树节点中包含的数据就是我们地形渲染中的Node：</p>
<figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">QuadTreeNode</span> : <span class="title">IReference</span></span><br><span class="line">{</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 四叉树中的深度</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> depth;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 在兄弟节点中的排序，顺序为左下，右下，左上，右上，分别对应0，1，2，3</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">uint</span> index;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点的正方形信息，坐标系为世界坐标</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 且左下角为坐标原点，x往右递增，y往上递增</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Rect rectInfo = Rect.zero;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 子节点，限定数量为4</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> List&lt;QuadTreeNode&gt; children = <span class="keyword">new</span> List&lt;QuadTreeNode&gt;(<span class="number">4</span>);</span><br><span class="line">    <span class="keyword">public</span> QuadTreeNode parent;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> isLeafNode =&gt; children.Count == <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 包含的对象，这里只用id索引，便于进行碰撞检测，这里的对象一定是自己完全包含的，不存在压线的情况</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> HashSet&lt;QuadTreeNodeContent&gt; containObject = <span class="keyword">new</span> HashSet&lt;QuadTreeNodeContent&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Clear</span>()</span></span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> child <span class="keyword">in</span> children)</span><br><span class="line">        {</span><br><span class="line">            ReferencePool.Release(child);</span><br><span class="line">        }</span><br><span class="line">        depth = <span class="number">0</span>;</span><br><span class="line">        index = <span class="number">0</span>;</span><br><span class="line">        rectInfo = Rect.zero;</span><br><span class="line">        parent = <span class="literal">null</span>;</span><br><span class="line">        containObject.Clear();</span><br><span class="line">        children.Clear();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">QuadTreeNodeContent</span> : <span class="title">IEquatable</span>&lt;<span class="title">QuadTreeNodeContent</span>&gt;, <span class="title">IReference</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> instanceId;</span><br><span class="line">    <span class="keyword">public</span> Rect rectInfo = Rect.zero;</span><br><span class="line">    <span class="keyword">public</span> QuadTreeNode belongToQuadTreeNode;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> QuadTreeNodeContent <span class="title">Init</span>(<span class="params"><span class="built_in">int</span> instanceId, Rect rect</span>)</span></span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">this</span>.instanceId = instanceId;</span><br><span class="line">        <span class="keyword">this</span>.rectInfo = rect;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Clear</span>()</span></span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">this</span>.instanceId = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">this</span>.rectInfo = Rect.zero;</span><br><span class="line">        <span class="keyword">this</span>.belongToQuadTreeNode = <span class="literal">null</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>可能有些抽象，画张图解释一下</p>
<iframe id="embed_dom" name="embed_dom" frameborder="0" style="display:block;width:100%; height:800px;" src="https://www.processon.com/embed/6495b8b8cdbc5438d2ac500c"></iframe>
<p>然后就是老生常谈的四叉树构造，地形节点的填入了，由于四叉树算法网上已经有很多讲解和实现，此处不再表述，可以参考：<a target="_blank" rel="noopener" href="https://pvigier.github.io/2019/08/04/quadtree-collision-detection.html">Quadtree and Collision Detection</a></p>
<p>这里只说几个注意点：</p>
<ul>
<li>每个节点都可以存储对象，不论是否是叶子节点，可以加速查找</li>
<li>当一个对象不被将要被细分的四叉树节点中的四个象限中的任意一个完全包含时，将不会进行细分</li>
<li>当一个对象不被四叉树节点完全包含的时候，需要分配到父节点</li>
<li>当一个对象不被四叉树节点的四个象限中的任意一个完全包含时，需要分配到四叉树节点本身</li>
<li>四叉树需要有动态更新的能力</li>
</ul>
<p>动态演示如下：</p>
<p><img src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/202306290109357.gif!webp" alt="the-last" loading='lazy'></p>
<h4 id="超大世界下的区域性四叉树">超大世界下的区域性四叉树</h4>
<p>因为我们的世界是<code>20.48km * 20.48km</code>，且Sector为64*64m，那么如果在整个世界范围内构建四叉树的话，至少需要将四叉树的深度拉伸到9以上<code>（即2^n &gt;= (20480/64 = 320)，n &gt; 8 =&gt; n = 9）</code>才能保证获取到每个Sector的LOD级数，由于四叉树深度过深，效率已经比较糟糕了</p>
<p>所以我们需要构建一个区域性的四叉树，尽量把四叉树深度保持在6以内，范围就是 <code>(2^6 = 64) * 64 = 4096</code> ，即我们的四叉树覆盖范围为<code>4096m*4096m</code>，区域外的部分一律采用LOD5进行渲染</p>
<p>这个区域性四叉树优点如下：</p>
<ul>
<li>较小的深度，保证查询效率</li>
<li>通过对比当前帧与前一帧的四叉树覆盖区域快速获得需要流式加载，卸载的节点</li>
<li>LOD0大小完全匹配Sector，便于后续数据准备收集工作</li>
<li>为后续的RVT提供数据支持</li>
<li>兼容任意大小的世界地形，同时可通过坐标偏移避免大世界浮点精度问题</li>
</ul>
<p>当然对于这个区域性的四叉树，我们需要保证其中心落点一直位于64的整数倍上，不然每个Sector就对不准我们离线切分的纹理大小了</p>
<p>示例如下：</p>
<p><img src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/202307151822259.png" alt="灰色为整个世界，线框部分为四叉树覆盖区域，面积为4096x4096m，其中最小的LOD（亮青色网格）为64x64m" loading='lazy'></p>
<h4 id="区域性四叉树移动触发流式">区域性四叉树移动触发流式</h4>
<p>当玩家进行移动时，四叉树会跟随更新，如果移动连续（即不进行传送操作），则可以求出这次移动需要加载和卸载的节点</p>
<p>示例如下：棕色部分为待卸载部分，绿色为复用部分，蓝色为待加载部分</p>
<iframe id="embed_dom" name="embed_dom" frameborder="0" style="display:block;width:100%; height:800px;" src="https://www.processon.com/embed/64b29038b39f42502598b900"></iframe>
<p>具体步骤为：</p>
<ul>
<li>设当前四叉树为X</li>
<li>当玩家移动距离相比上一次记录累计超过LOD0（64m）阈值时触发流式</li>
<li>计算出需要加载的范围A，卸载的范围B，以及重合的范围C</li>
<li>由于我们LOD层级较多，基本上每次移动都会触发大部分节点的重建，所以直接重建整颗四叉树得到Y</li>
<li>将需要加载的范围A和Y做相交测试，得到覆盖的节点，以及对应的待加载资源列表a</li>
<li>将需要卸载的范围B和Y做相交测试，得到覆盖的节点，以及对应的待卸载资源列表b</li>
<li>将重合的范围C和X，Y做相交测试，得到相对的覆盖节点，对节点进行一一对比，如果节点的位置和四叉树层级（LOD等级）均相同，则认为此节点无需加载资源，否则此节点需要卸载引用资源，并重新加载新的对应资源，得到待加载的资源列表c，以及待卸载的资源d</li>
<li>对a，c资源列表进行加载，对b，d资源列表进行卸载</li>
<li>PS1：当然如果项目的资源管理模块做的比较吊的话，可以忽略上述复杂的加载卸载步骤，只需要无脑卸载上一帧残余资源，加载这一帧所有资源即可，由资源管理模块进行处理</li>
</ul>
<p>区域性四叉树跟随移动表现如下：</p>
<p><img src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/202307161504183.gif!webp" alt="the-last" loading='lazy'></p>
<p>当然，仅仅是这样是有问题的，因为我们是依据LOD0的阈值来重建整颗四叉树，这样会导致其余LOD等级的对应资源无法被正确加载，例如LOD1覆盖区域为128x128m，在离线切分纹理的时候每个tile是固定的，即x轴间隔0，128，256三张纹理，那么x为64的时候，是没有对应纹理的，只能继续复用x为0时的纹理。</p>
<p><strong>综上，我们只有在四叉树中最高等级的LOD发生变动的时候才会移动整颗四叉树，否则以各个LOD等级贴图切分规格进行流式加载和卸载</strong>，示例如下：</p>
<p><img src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/202307221358631.gif!webp" alt="the-last" loading='lazy'></p>
<h4 id="世界原点与Node布局">世界原点与Node布局</h4>
<p>为了最大限度利用浮点精度范围，我们把世界中心点设置在世界坐标原点处</p>
<p>为了和四叉树统一排列算法，世界左下角为tile0，从左到右，从下到上进行排列，就像这样：</p>
<iframe id="embed_dom" name="embed_dom" frameborder="0" style="display:block;width:100%; height:800px;" src="https://www.processon.com/embed/64fc4e6300a5c32bca801235"></iframe>
<h4 id="Node内容">Node内容</h4>
<p>对于地形高度渲染，每个Node至少需要有以下数据</p>
<figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> ET.QuadTree;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ET</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TerrianNode</span> : <span class="title">IReference</span></span><br><span class="line">    {</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 引用的四叉树节点Id，四叉树节点自身拥有世界空间坐标，大小等数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">long</span> instanceId;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> QuadTreeNodeContent quadTreeNodeContent;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> LOD等级</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">uint</span> lodLevel;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 对应lod下的x,y索引</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> Vector2Int nodeIndexer;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> nodeIndex =&gt; nodeIndexer.y * nodeCount + nodeIndexer.x;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> nodeCount;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 归属Tile索引</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> Vector2Int tileIndexer;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> tileIndex =&gt; tileIndexer.y * tileCount + tileIndexer.x;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> tileCount;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 引用的textureArray中的纹理索引</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">uint</span> refHeightFieldTextureArrayIndex;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> TerrianNode <span class="title">Init</span>(<span class="params"><span class="built_in">float</span> worldSize, QuadTree.QuadTree quadTree, QuadTreeNodeContent quadTreeNodeContent</span>)</span></span><br><span class="line">        {</span><br><span class="line">            <span class="keyword">this</span>.quadTreeNodeContent = quadTreeNodeContent;</span><br><span class="line">            <span class="built_in">int</span> maxLod = quadTree.maxDepthLimit - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">float</span> tilesize = <span class="number">64</span> * Mathf.Pow(<span class="number">2</span>, maxLod);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> lodSize = quadTreeNodeContent.rectInfo.size.x;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">int</span> maxNodeIndex = Mathf.RoundToInt(tilesize / lodSize);</span><br><span class="line"></span><br><span class="line">            lodLevel = (<span class="built_in">uint</span>)Mathf.RoundToInt(Mathf.Log(lodSize / <span class="number">64</span>, <span class="number">2.0f</span>));</span><br><span class="line"></span><br><span class="line">            nodeIndexer = <span class="keyword">new</span> Vector2Int(</span><br><span class="line">                Mathf.RoundToInt((quadTreeNodeContent.rectInfo.x + worldSize / <span class="number">2</span>) / lodSize) % maxNodeIndex,</span><br><span class="line">                Mathf.RoundToInt((quadTreeNodeContent.rectInfo.y + worldSize / <span class="number">2</span>) / lodSize) % maxNodeIndex);</span><br><span class="line"></span><br><span class="line">            tileIndexer =</span><br><span class="line">                <span class="keyword">new</span> Vector2Int(Mathf.FloorToInt((quadTreeNodeContent.rectInfo.x + worldSize / <span class="number">2</span>) / tilesize),</span><br><span class="line">                    Mathf.FloorToInt(</span><br><span class="line">                        (quadTreeNodeContent.rectInfo.y + worldSize / <span class="number">2</span>) / tilesize));</span><br><span class="line"></span><br><span class="line">            nodeCount = Mathf.RoundToInt(worldSize / lodSize);</span><br><span class="line">            tileCount = Mathf.RoundToInt(worldSize / tilesize);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Clear</span>()</span></span><br><span class="line">        {</span><br><span class="line">            <span class="keyword">this</span>.quadTreeNodeContent = <span class="literal">null</span>;</span><br><span class="line">            instanceId = <span class="number">0</span>;</span><br><span class="line">            refHeightFieldTextureArrayIndex = <span class="number">0</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>具体的构造逻辑可见：</p>
<iframe id="embed_dom" name="embed_dom" frameborder="0" style="display:block;width:100%; height:800px;" src="https://www.processon.com/embed/64fc4e6300a5c32bca801235"></iframe>
<h4 id="四叉树剔除">四叉树剔除</h4>
<p>在将数据同步至GPU之前，我们需要先进行一次Node粒度的剔除，可以有效减少带宽和GPU剔除压力</p>
<p>借助四叉树的结构特性，可以实现较为高效的剔除</p>
<figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 遍历整颗四叉树</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="trigger"&gt;</span>判定某个rect是否在检测范围内，用于减少遍历次数<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="traverseCallback"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">TraverseTree</span>(<span class="params">Func&lt;Rect, <span class="built_in">bool</span>&gt; trigger, Action&lt;QuadTreeNode&gt; traverseCallback</span>)</span></span><br><span class="line">{</span><br><span class="line">    TraverseTreeInternal(trigger, root, traverseCallback);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">TraverseTreeInternal</span>(<span class="params">Func&lt;Rect, <span class="built_in">bool</span>&gt; trigger, QuadTreeNode quadTreeNode,</span></span></span><br><span class="line"><span class="params"><span class="function">    Action&lt;QuadTreeNode&gt; traverseCallback</span>)</span></span><br><span class="line">{</span><br><span class="line">    <span class="comment">// 如果节点判断失败，则直接终止</span></span><br><span class="line">    <span class="keyword">if</span> (trigger != <span class="literal">null</span> &amp;&amp; !trigger.Invoke(quadTreeNode.rectInfo))</span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    traverseCallback?.Invoke(quadTreeNode);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> child <span class="keyword">in</span> quadTreeNode.children)</span><br><span class="line">    {</span><br><span class="line">        TraverseTreeInternal(trigger, child, traverseCallback);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>碰撞检测基于相机的视锥体进行，剔除代码和debug代码如下：</p>
<figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Camera cam = Camera.main;</span><br><span class="line">GeometryUtility.CalculateFrustumPlanes(cam, cameraFrustumPlanes); <span class="comment">//Ordering: [0] = Left, [1] = Right, [2] = Down, [3] = Up, [4] = Near, [5] = Far</span></span><br><span class="line"></span><br><span class="line">PoolableList&lt;QuadTreeNode&gt; result = ReferencePool.Acquire&lt;PoolableList&lt;QuadTreeNode&gt;&gt;();</span><br><span class="line">{</span><br><span class="line">    m_quadTree.TraverseTree((x) =&gt;</span><br><span class="line">    {</span><br><span class="line">        Bounds cellBound = <span class="keyword">new</span> Bounds(<span class="keyword">new</span> Vector3(x.center.x, <span class="number">0</span>, x.center.y),</span><br><span class="line">            <span class="keyword">new</span> Vector3(x.size.x, <span class="number">0</span>, x.size.y));</span><br><span class="line">        <span class="keyword">return</span> GeometryUtility.TestPlanesAABB(cameraFrustumPlanes, cellBound);</span><br><span class="line">    }, (x) =&gt; { result.<span class="keyword">value</span>.Add(x); });</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> quadTreeNode <span class="keyword">in</span> result.<span class="keyword">value</span>)</span><br><span class="line">{</span><br><span class="line">    <span class="comment">// 绘制所有通过测试的节点</span></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> content <span class="keyword">in</span> quadTreeNode.containObject)</span><br><span class="line">    {</span><br><span class="line">        Popcron.Gizmos.Cube(<span class="keyword">new</span> Vector3(content.rectInfo.center.x, <span class="number">0</span>, content.rectInfo.center.y),</span><br><span class="line">            Quaternion.identity, <span class="keyword">new</span> Vector3(content.rectInfo.size.x, <span class="number">100</span>, content.rectInfo.size.y),</span><br><span class="line">            Color.green);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">ReferencePool.Release(result);</span><br></pre></td></tr></tbody></table></figure>
<p>效果如下：</p>
<p><img src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/202309102015782.gif!webp" alt="the-last" loading='lazy'></p>
<p>我们再把目光聚焦到TerrianHeightFieldComponent上来</p>
<h3 id="TerrianHeightFieldComponent">TerrianHeightFieldComponent</h3>
<p>作为渲染地形基础骨架的组件，我们地形高度的渲染准备工作就在此组件进行</p>
<p>主要内容是纹理数组和一些ComputeBuffer，以及用于IndirectDraw的args</p>
<figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TerrianHeightFieldComponent</span> : <span class="title">Entity</span>, <span class="title">IAwake</span>, <span class="title">IDestroy</span>, <span class="title">ILateUpdate</span></span><br><span class="line">{</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 用于记录高度图在TextureArray中的索引</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">int</span>&gt; hfTextureIndexer = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">int</span>&gt;();</span><br><span class="line">    <span class="keyword">public</span> Dictionary&lt;<span class="built_in">string</span>, TerrianResLoaderComponent.LoadState&gt; loadState = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, TerrianResLoaderComponent.LoadState&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> 地形渲染</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Patch信息</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">struct</span> HeightField_NodeInfo</span><br><span class="line">    {</span><br><span class="line">        <span class="comment">// 世界空间坐标，（左下角）</span></span><br><span class="line">        <span class="keyword">public</span> Vector2 posXZ_World;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">uint</span> lod;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">uint</span> textureArrayIndex;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">struct</span> HeightField_PatchInfo</span><br><span class="line">    {</span><br><span class="line">        <span class="comment">// 世界空间坐标，（左下角）</span></span><br><span class="line">        <span class="comment">// 归属Node的世界空间坐标，（左下角）</span></span><br><span class="line">        Vector2 belongToNodePosXZ_World;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * \brief 在Node中的xz索引，从左到右，从下到上</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        Vector2Int indexXZ_Local;</span><br><span class="line">        <span class="built_in">uint</span> lod;</span><br><span class="line">        <span class="built_in">uint</span> textureArrayIndex;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> https://docs.unity3d.com/ScriptReference/Graphics.DrawMeshInstancedIndirect.html</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 0：mesh Index</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 1: DrawMeshInstancedIndirect count</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 2：mesh IndexStart</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 3：mesh BaseVertex</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 4: mesh Start</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> https://docs.unity3d.com/ScriptReference/ComputeShader.DispatchIndirect.html</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 5：build Patch DispatchCompute threadGroupX: 8</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 6：build Patch DispatchCompute threadGroupY: 8</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 7：build Patch DispatchCompute threadGroupZ: 1</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> </span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">uint</span>[] <span class="keyword">args</span> = <span class="keyword">new</span> <span class="built_in">uint</span>[<span class="number">5</span>] { <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span> };</span><br><span class="line">    <span class="keyword">public</span> ComputeBuffer heightFieldNodeInfoCB;</span><br><span class="line">    <span class="keyword">public</span> ComputeBuffer heightFieldPatchInfoCB;</span><br><span class="line">    <span class="keyword">public</span> ComputeBuffer heightFieldIndirectArgCB;</span><br><span class="line">    <span class="keyword">public</span> Texture2DArray heightFieldTextureArray;</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>组件的初始化逻辑就是数据的初始化</p>
<p>因为我们需要基于TextureArray进行渲染，所以需要一个纹理数组，且我们的高度图为R16深度，且分辨率为128x128，所以Unity内压缩设置为R16bit（即无压缩，一定不能对高度图进行压缩，否则会导致数据异常）</p>
<p><img src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/202305272231307.png" alt="Texture2DArray示意" loading='lazy'></p>
<figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TerrianRenderComponentAwakeSystems</span> : <span class="title">AwakeSystem</span>&lt;<span class="title">TerrianHeightFieldComponent</span>&gt;</span><br><span class="line">{</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Awake</span>(<span class="params">TerrianHeightFieldComponent self</span>)</span></span><br><span class="line">    {</span><br><span class="line">        self.heightFieldTextureArray = <span class="keyword">new</span> Texture2DArray(<span class="number">128</span>, <span class="number">128</span>, <span class="number">512</span>, TextureFormat.R16, <span class="literal">false</span>);</span><br><span class="line">        self.heightFieldTextureArray.filterMode = FilterMode.Point;</span><br><span class="line"></span><br><span class="line">        self.heightFieldIndirectArgCB =</span><br><span class="line">            <span class="keyword">new</span> ComputeBuffer(<span class="number">1</span>, self.<span class="keyword">args</span>.Length * <span class="keyword">sizeof</span>(<span class="built_in">uint</span>), ComputeBufferType.IndirectArguments);</span><br><span class="line">        self.heightFieldNodeInfoCB = <span class="keyword">new</span> ComputeBuffer(<span class="number">256</span>, <span class="number">4</span> * <span class="keyword">sizeof</span>(<span class="built_in">float</span>), ComputeBufferType.Append);</span><br><span class="line">        self.heightFieldPatchInfoCB = <span class="keyword">new</span> ComputeBuffer(<span class="number">256</span> * <span class="number">64</span>, <span class="number">6</span> * <span class="keyword">sizeof</span>(<span class="built_in">float</span>), ComputeBufferType.Append);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="流式加载">流式加载</h4>
<p>首先需要明确的一点，由于我们资源加载是异步的，所以必须保证视野变化时资源已提前加载，也就是说，我们需要<code>额外加载视野外的资源</code>才能保证渲染的实时性和准确性，当然这个额外加载的资源量是有限制的，一般来说：</p>
<ul>
<li>当前视角范围及最外围相邻的资源</li>
<li>当前视角余角及最外围相邻的资源</li>
</ul>
<p>看似情况复杂，其实总结下来就是：取相机xz坐标为圆心，以（当前视锥范围内距离相机最远的四叉树节点与相机的距离（取y=0）+<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span>）为半径的圆和四叉树的节点交集即可，其中<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span>具体数值可以根据可视距离和相机的FOV来进行计算</p>
<p>最后需要注意的是，我们并不会立即卸载那些理应卸载的节点资源，例如：</p>
<ul>
<li>被剔除的节点资源</li>
<li>四叉树重建后失效的节点资源</li>
</ul>
<p>保留这部分缓存可以保证一段距离内的无感知加载，我们通过<code>设置一个缓冲区大小和LRU策略</code>来实现这个功能，此块实现比较业务，比较详细的思路参见：<a href="https://www.lfzxb.top/solve-async-load-use-problem-with-classic-producer-consumer-model/">用经典的生产-消费者模型解决游戏开发中异步加载和使用问题</a></p>
<p>图示如下：</p>
<iframe id="embed_dom" name="embed_dom" frameborder="0" style="display:block;width:100%; height:800px;" src="https://www.processon.com/embed/65ce0aea18fbfc6b5eeb8307"></iframe>
<h1>GPU（一阶段）</h1>
<p>我们通过ComputeBuffer将数据同步至GPU进行计算和最终渲染</p>
<h2 id="HeightField-RenderFeature">HeightField RenderFeature</h2>
<p>这里通过Unity URP的RenderFeature功能进行地形渲染的组织和提交，我们需要以下对象：</p>
<ul>
<li>用于组成Node的Mesh（Patch）</li>
<li>用于地形渲染的Material</li>
<li>用于提供地形渲染所需Indirect数据的Compute Shader</li>
</ul>
<figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HeightFieldRenderFeature</span> : <span class="title">ScriptableRendererFeature</span></span><br><span class="line">{</span><br><span class="line">    [<span class="meta">System.Serializable</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Setting</span></span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">public</span> Mesh terrianNodeMesh;</span><br><span class="line">        <span class="keyword">public</span> Material terrianHeightFieldMat;</span><br><span class="line">        <span class="keyword">public</span> ComputeShader terrianHeightFieldCS;</span><br><span class="line">        <span class="comment">// 指定地形渲染先于不透明物体，有助于减少OverDraw</span></span><br><span class="line">        <span class="keyword">public</span> RenderPassEvent passEvent = RenderPassEvent.BeforeRenderingOpaques;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">public</span> Setting setting = <span class="keyword">new</span> Setting();</span><br><span class="line">    <span class="keyword">public</span> HeightFieldRenderPass heightFieldRenderPass;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Create</span>()</span></span><br><span class="line">    {</span><br><span class="line">        heightFieldRenderPass = <span class="keyword">new</span> HeightFieldRenderPass(setting);</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">AddRenderPasses</span>(<span class="params">ScriptableRenderer renderer, <span class="keyword">ref</span> RenderingData renderingData</span>)</span></span><br><span class="line">    {</span><br><span class="line">        renderer.EnqueuePass(heightFieldRenderPass);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>在配置完成之后，即可在具体的RenderPass驱动渲染，为了便于阅读代码，我省略了Dirty Update部分，从而展现完整的数据构建，提交，渲染流程</p>
<figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Execute</span>(<span class="params">ScriptableRenderContext context, <span class="keyword">ref</span> RenderingData renderingData</span>)</span></span><br><span class="line">{</span><br><span class="line">    CommandBuffer cmd = CommandBufferPool.Get(<span class="string">"ProjectS_RenderHeightField"</span>);</span><br><span class="line">    Scene scene = Game.Scene.GetComponent&lt;ClientSceneManagerComponent&gt;().GetCurrentSingleGameScene();</span><br><span class="line">    <span class="keyword">if</span> (scene == <span class="literal">null</span>)</span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    Init();</span><br><span class="line">    TerrianRenderComponent terrianRenderComponent =</span><br><span class="line">        scene.GetComponent&lt;Terrian&gt;().GetComponent&lt;TerrianRenderComponent&gt;();</span><br><span class="line">    TerrianHeightFieldComponent terrianHeightFieldComponent =</span><br><span class="line">        terrianRenderComponent.GetComponent&lt;TerrianHeightFieldComponent&gt;();</span><br><span class="line">    <span class="comment">// 更新ComputeBuffer内容</span></span><br><span class="line">    <span class="keyword">using</span> (<span class="keyword">var</span> listInstance =</span><br><span class="line">           ReferencePool.Acquire&lt;PoolableList&lt;TerrianHeightFieldComponent.HeightField_NodeInfo&gt;&gt;())</span><br><span class="line">    {</span><br><span class="line">        <span class="comment">// 清理数据</span></span><br><span class="line">        cmd.SetBufferCounterValue(terrianHeightFieldComponent.heightFieldNodeInfoCB, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 更新Node内容</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> terrianNode <span class="keyword">in</span> terrianRenderComponent.terrianNodes)</span><br><span class="line">        {</span><br><span class="line">            <span class="keyword">if</span> (terrianHeightFieldComponent.hfTextureIndexer.TryGetValue(</span><br><span class="line">                    TerrianResLoaderComponentSystem.GetHeightFieldTextureAssetPath(terrianNode), <span class="keyword">out</span> <span class="keyword">var</span> index))</span><br><span class="line">            {</span><br><span class="line">                terrianNode.refHeightFieldTextureArrayIndex = (<span class="built_in">uint</span>)index;</span><br><span class="line">            }</span><br><span class="line">            listInstance.<span class="keyword">value</span>.Add(<span class="keyword">new</span> TerrianHeightFieldComponent.HeightField_NodeInfo()</span><br><span class="line">            {</span><br><span class="line">                lod = terrianNode.lodLevel, posXZ_World = terrianNode.quadTreeNodeContent.rectInfo.position,</span><br><span class="line">                textureArrayIndex = terrianNode.refHeightFieldTextureArrayIndex</span><br><span class="line">            });</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 更新Node列表</span></span><br><span class="line">        cmd.SetBufferData(terrianHeightFieldComponent.heightFieldNodeInfoCB, listInstance.<span class="keyword">value</span>);</span><br><span class="line">        cmd.SetBufferCounterValue(terrianHeightFieldComponent.heightFieldPatchInfoCB, <span class="number">0</span>);</span><br><span class="line">        cmd.SetComputeBufferParam(<span class="keyword">this</span>.m_setting.terrianHeightFieldCS, m_buildPatchKernelIndex,</span><br><span class="line">            HeightFieldNodeInfoBuffer,</span><br><span class="line">            terrianHeightFieldComponent.heightFieldNodeInfoCB);</span><br><span class="line">        cmd.SetComputeBufferParam(<span class="keyword">this</span>.m_setting.terrianHeightFieldCS, m_buildPatchKernelIndex,</span><br><span class="line">            HeightFieldPatchInfoBuffer,</span><br><span class="line">            terrianHeightFieldComponent.heightFieldPatchInfoCB);</span><br><span class="line">        </span><br><span class="line">        Matrix4x4 v = terrianRenderComponent.camera.worldToCameraMatrix;</span><br><span class="line">        Matrix4x4 p = terrianRenderComponent.camera.projectionMatrix;</span><br><span class="line">        Matrix4x4 vp = p * v;</span><br><span class="line">        <span class="comment">// 传入VP矩阵，获取到clip空间坐标</span></span><br><span class="line">        cmd.SetComputeMatrixParam(<span class="keyword">this</span>.m_setting.terrianHeightFieldCS, VPMatrix, vp);</span><br><span class="line">        <span class="comment">// 构建Patch</span></span><br><span class="line">        cmd.DispatchCompute(m_setting.terrianHeightFieldCS, m_buildPatchKernelIndex,</span><br><span class="line">            listInstance.<span class="keyword">value</span>.Count, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 更新需要绘制的数量</span></span><br><span class="line">        cmd.CopyCounterValue(terrianHeightFieldComponent.heightFieldPatchInfoCB,</span><br><span class="line">            terrianHeightFieldComponent.heightFieldIndirectArgCB, <span class="keyword">sizeof</span>(<span class="built_in">uint</span>));</span><br><span class="line">        <span class="built_in">uint</span>[] indirtCount = <span class="keyword">new</span> <span class="built_in">uint</span>[<span class="number">5</span>];</span><br><span class="line">        terrianHeightFieldComponent.heightFieldIndirectArgCB.GetData(indirtCount);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// GPU DrawCall</span></span><br><span class="line">    cmd.DrawMeshInstancedIndirect(m_setting.terrianNodeMesh, <span class="number">0</span>, m_setting.terrianHeightFieldMat, <span class="number">0</span>,</span><br><span class="line">        terrianHeightFieldComponent.heightFieldIndirectArgCB);</span><br><span class="line">    context.ExecuteCommandBuffer(cmd);</span><br><span class="line">    CommandBufferPool.Release(cmd);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Patch构建-剔除">Patch构建&amp;&amp;剔除</h3>
<p>Node的来源是四叉树，为了获取更高的网格精度和渲染性能，我们的mesh大小只有8x8，但Node最小LOD都有64，所以需要将Node打散成Patch，然后进行剔除和渲染</p>
<p><img src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/202310292142758.png" alt="" loading='lazy'></p>
<p>为了避免CPU和GPU同步数据，我们让整个过程Indirect，即在GPU进行，通过Compute Shader实现</p>
<p>此外，为了最大限度利用GPU的并行性，我们以<code>patch/64</code>数量而非node数量作为dispatch目标数(因为我们numthreads为8x8)</p>
<p>因为基于NodeCount来处理，在最低级的LOD6上，每个Thread要写入<code>2^6^2 = 32^2</code>个值，而基于patch，可以让每个线程只写入1个数值即可</p>
<ul>
<li>Node Count作为Thread count，Thread数量少，单个Thread写入数据多</li>
<li>Patch Count作为Thread count，Thread数量多，单个Thread写入数据少</li>
</ul>
<figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmd.DispatchCompute(m_setting.terrianHeightFieldCS, m_buildPatchKernelIndex,listInstance.<span class="keyword">value</span>.Count, <span class="number">1</span>, <span class="number">1</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>构建patch的compute shader如下</p>
<figure class="highlight glsl"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#pragma kernel BuildPatch</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//NUMTHREAD_X * NUMTHREAD_Y must be multiple of 64 and &lt;= 256 to balance between performance and mobile support, so we use 8*8</span></span><br><span class="line"><span class="meta">#define NUMTHREAD_X 8</span></span><br><span class="line"><span class="meta">#define NUMTHREAD_Y 8</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#include "./TerrianCore.hlsl"</span></span><br><span class="line"><span class="meta">#include "../Common/MathUtil.hlsl"</span></span><br><span class="line"></span><br><span class="line">RWStructuredBuffer&lt;HeightField_NodeInfo&gt; heightField_NodeInfoBuffer;</span><br><span class="line">AppendStructuredBuffer&lt;HeightField_PatchInfo&gt; heightField_PatchInfoBuffer;</span><br><span class="line">float4 frustumPlanes[<span class="number">6</span>];</span><br><span class="line"></span><br><span class="line">[numthreads(NUMTHREAD_X,NUMTHREAD_Y,<span class="number">1</span>)]</span><br><span class="line"><span class="type">void</span> BuildPatch(uint3 id : SV_DispatchThreadID, uint3 groupId:SV_GroupID, uint3 groupThreadId:SV_GroupThreadID)</span><br><span class="line">{</span><br><span class="line">    <span class="comment">// groupId.x即为nodeIndex</span></span><br><span class="line">    <span class="keyword">const</span> HeightField_NodeInfo height_field_node_info = heightField_NodeInfoBuffer[groupId.x];</span><br><span class="line"></span><br><span class="line">    HeightField_PatchInfo height_field_patch_info;</span><br><span class="line"></span><br><span class="line">    height_field_patch_info.belongToNodePosXZ_World = height_field_node_info.posXZ_World;</span><br><span class="line">    height_field_patch_info.indexXZ_Local = uint2(groupThreadId.x, groupThreadId.y);</span><br><span class="line">    height_field_patch_info.lod = height_field_node_info.lod;</span><br><span class="line">    height_field_patch_info.textureArrayIndex = height_field_node_info.textureArrayIndex;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 整个patch的大小</span></span><br><span class="line">    <span class="type">float</span> pacth_size = <span class="number">8</span> * <span class="built_in">pow</span>(<span class="number">2</span>, height_field_patch_info.lod);</span><br><span class="line">    <span class="type">float</span> node_size = <span class="number">8</span> * pacth_size;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 先将patch转换到node空间</span></span><br><span class="line">    <span class="comment">// 为了统一shader运算，将坐标系转换到中心点</span></span><br><span class="line">    <span class="comment">// 因为thread count xy为 8 * 8，所以要转换成中心点的话，得 -4 得到左下角坐标，再 +0.5 得到中心点坐标</span></span><br><span class="line">    <span class="keyword">const</span> float2 localXZ_NS = ((height_field_patch_info.indexXZ_Local - <span class="number">4</span> + <span class="number">0.5</span>) * pacth_size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 世界空间平移 + 模型空间偏移 + 中心点修正</span></span><br><span class="line">    float2 posXZ_WS = localXZ_NS + node_size / <span class="number">2</span> + height_field_patch_info.belongToNodePosXZ_World;</span><br><span class="line">    <span class="type">float</span> half_xz = pacth_size / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注意，我们没有每个patch的高度信息，所以这里先置为0</span></span><br><span class="line">    float3 boundMax = float3(posXZ_WS.x + half_xz, <span class="number">0</span>, posXZ_WS.y + half_xz);</span><br><span class="line">    float3 boundMin = float3(posXZ_WS.x - half_xz, <span class="number">0</span>, posXZ_WS.y - half_xz);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 视锥体裁剪</span></span><br><span class="line">    <span class="keyword">if</span> (FrustumCullBound(boundMin, boundMax, frustumPlanes))</span><br><span class="line">    {</span><br><span class="line">        heightField_PatchInfoBuffer.Append(height_field_patch_info);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>其中的数据结构需要同我们CPU端一致</p>
<figure class="highlight glsl"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">struct HeightField_NodeInfo</span><br><span class="line">{</span><br><span class="line">    <span class="comment">// 世界空间坐标，（左下角）</span></span><br><span class="line">    float2 posXZ_World;</span><br><span class="line">    <span class="type">uint</span> lod;</span><br><span class="line">    <span class="type">uint</span> textureArrayIndex;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">struct HeightField_PatchInfo</span><br><span class="line">{</span><br><span class="line">    <span class="comment">// 归属Node的世界空间坐标，（左下角）</span></span><br><span class="line">    float2 belongToNodePosXZ_World;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * \brief 在Node中的xz索引，从左到右，从下到上</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    int2 indexXZ_Local;</span><br><span class="line">    <span class="type">uint</span> lod;</span><br><span class="line">    <span class="type">uint</span> textureArrayIndex;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<p>我们可以看到FrustumCullBound函数对地形tile进行了剔除操作，思路来自：<a target="_blank" rel="noopener" href="https://github.com/lijundacom/LeoGPUDriven">https://github.com/lijundacom/LeoGPUDriven</a></p>
<p>可以简单概括为：</p>
<p>计算出包围盒8个点中距离平面最近的点<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>n</mi><mi>e</mi><mi>a</mi><mi>r</mi></mrow></msub></mrow><annotation encoding="application/x-tex">P_{near}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>和距离平面最远的点(最远对角线的顶点)<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>f</mi><mi>a</mi><mi>r</mi></mrow></msub></mrow><annotation encoding="application/x-tex">P_{far}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>。</p>
<p>如果<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>n</mi><mi>e</mi><mi>a</mi><mi>r</mi></mrow></msub></mrow><annotation encoding="application/x-tex">P_{near}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>在平面外部，则立方体在平面外部。</p>
<p>如果<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>n</mi><mi>e</mi><mi>a</mi><mi>r</mi></mrow></msub></mrow><annotation encoding="application/x-tex">P_{near}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>f</mi><mi>a</mi><mi>r</mi></mrow></msub></mrow><annotation encoding="application/x-tex">P_{far}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>一个在平面内部，一个在平面外部，则包围盒与平面相交。</p>
<p>如果<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>n</mi><mi>e</mi><mi>a</mi><mi>r</mi></mrow></msub></mrow><annotation encoding="application/x-tex">P_{near}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>f</mi><mi>a</mi><mi>r</mi></mrow></msub></mrow><annotation encoding="application/x-tex">P_{far}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>都在平面外部，则包围盒在平面外部。</p>
<p>计算<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>n</mi><mi>e</mi><mi>a</mi><mi>r</mi></mrow></msub></mrow><annotation encoding="application/x-tex">P_{near}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>f</mi><mi>a</mi><mi>r</mi></mrow></msub></mrow><annotation encoding="application/x-tex">P_{far}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>的方式是：</p>
<p>首先计算<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub></mrow><annotation encoding="application/x-tex">P_{max}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msub></mrow><annotation encoding="application/x-tex">P_{min}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">min</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub><mo>=</mo><mi>m</mi><mi>a</mi><mi>x</mi><mo stretchy="false">(</mo><msub><mi>P</mi><mn>0</mn></msub><mo separator="true">,</mo><msub><mi>P</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>P</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>P</mi><mn>3</mn></msub><mo separator="true">,</mo><msub><mi>P</mi><mn>4</mn></msub><mo separator="true">,</mo><msub><mi>P</mi><mn>5</mn></msub><mo separator="true">,</mo><msub><mi>P</mi><mn>6</mn></msub><mo separator="true">,</mo><msub><mi>P</mi><mn>7</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P_{max} = max(P_0,P_1,P_2,P_3,P_4,P_5,P_6,P_7)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">ma</span><span class="mord mathnormal">x</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">6</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">7</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msub><mo>=</mo><mi>m</mi><mi>i</mi><mi>n</mi><mo stretchy="false">(</mo><msub><mi>P</mi><mn>0</mn></msub><mo separator="true">,</mo><msub><mi>P</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>P</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>P</mi><mn>3</mn></msub><mo separator="true">,</mo><msub><mi>P</mi><mn>4</mn></msub><mo separator="true">,</mo><msub><mi>P</mi><mn>5</mn></msub><mo separator="true">,</mo><msub><mi>P</mi><mn>6</mn></msub><mo separator="true">,</mo><msub><mi>P</mi><mn>7</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P_{min} = min(P_0,P_1,P_2,P_3,P_4,P_5,P_6,P_7)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">min</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">min</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">6</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">7</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></p>
<p>然后</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>n</mi><mi>e</mi><mi>a</mi><mi>r</mi></mrow></msub><mo>=</mo><msub><mi>P</mi><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msub></mrow><annotation encoding="application/x-tex">P_{near} = P_{min}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">min</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>,</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>f</mi><mi>a</mi><mi>r</mi></mrow></msub><mo>=</mo><msub><mi>P</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub></mrow><annotation encoding="application/x-tex">P_{far} = P_{max}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>,</p>
<p>最后</p>
<p>$if(N.x &gt; 0)  P_{near}.x = P_{max}.x; $</p>
<p>$if(N.y &gt; 0)  P_{near}.y = P_{max}.y; $</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mi>f</mi><mo stretchy="false">(</mo><mi>N</mi><mi mathvariant="normal">.</mi><mi>z</mi><mo>&gt;</mo><mn>0</mn><mo stretchy="false">)</mo><msub><mi>P</mi><mrow><mi>n</mi><mi>e</mi><mi>a</mi><mi>r</mi></mrow></msub><mi mathvariant="normal">.</mi><mi>z</mi><mo>=</mo><msub><mi>P</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub><mi mathvariant="normal">.</mi><mi>z</mi><mo separator="true">;</mo></mrow><annotation encoding="application/x-tex">if(N.z &gt; 0)  P_{near}.z = P_{max}.z;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">0</span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mpunct">;</span></span></span></span></p>
<p>$if(N.x &gt; 0)  P_{far}.x = P_{min}.x; $</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mi>f</mi><mo stretchy="false">(</mo><mi>N</mi><mi mathvariant="normal">.</mi><mi>y</mi><mo>&gt;</mo><mn>0</mn><mo stretchy="false">)</mo><msub><mi>P</mi><mrow><mi>f</mi><mi>a</mi><mi>r</mi></mrow></msub><mi mathvariant="normal">.</mi><mi>y</mi><mo>=</mo><msub><mi>P</mi><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msub><mi mathvariant="normal">.</mi><mi>y</mi><mo separator="true">;</mo></mrow><annotation encoding="application/x-tex">if(N.y &gt; 0)  P_{far}.y = P_{min}.y;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord">0</span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">min</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mpunct">;</span></span></span></span></p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mi>f</mi><mo stretchy="false">(</mo><mi>N</mi><mi mathvariant="normal">.</mi><mi>z</mi><mo>&gt;</mo><mn>0</mn><mo stretchy="false">)</mo><msub><mi>P</mi><mrow><mi>f</mi><mi>a</mi><mi>r</mi></mrow></msub><mi mathvariant="normal">.</mi><mi>z</mi><mo>=</mo><msub><mi>P</mi><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msub><mi mathvariant="normal">.</mi><mi>z</mi><mo separator="true">;</mo></mrow><annotation encoding="application/x-tex">if(N.z &gt; 0)  P_{far}.z = P_{min}.z;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord">0</span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">min</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mpunct">;</span></span></span></span></p>
<p><img src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/202403020055193.png" alt="image-20240302005505125" loading='lazy'></p>
<h3 id="高度图采样">高度图采样</h3>
<p>因为我们通过GPU Instance绘制mesh，所以需要自己在vs构建uv对高度图采样，在具体公式如下</p>
<p>（需要注意的是，Shader中为了统一坐标系，统一转换到rect中心进行矩阵计算）</p>
<iframe id="embed_dom" name="embed_dom" frameborder="0" style="display:block;width:100%; height:500px;" src="https://www.processon.com/embed/653488c2c2075537bb08adba"></iframe>
<figure class="highlight glsl"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line">Shader "ProjectS/TerrianHeightField"</span><br><span class="line">{</span><br><span class="line">    Properties</span><br><span class="line">    {</span><br><span class="line">        _MainTex ("颜色贴图", <span class="number">2</span>D) = "white" {}</span><br><span class="line"></span><br><span class="line">        [Main(Debug, _DEBUG, on)]</span><br><span class="line">        _debug ("调试模式", <span class="type">float</span>) = <span class="number">0</span></span><br><span class="line">        [SubToggle(Debug, _USE_LOCAL_UV)]</span><br><span class="line">        _use_Local_UV("使用自身UV采样颜色", <span class="type">float</span>) = <span class="number">0</span></span><br><span class="line">        [SubToggle(Debug, _SHOW_UV)]</span><br><span class="line">        _show_UV("显示UV", <span class="type">float</span>) = <span class="number">0</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    SubShader</span><br><span class="line">    {</span><br><span class="line">        Tags</span><br><span class="line">        {</span><br><span class="line">            "RenderType" = "Opaque" "RenderPipeline" = "UniversalRenderPipeline"</span><br><span class="line">        }</span><br><span class="line">        Pass</span><br><span class="line">        {</span><br><span class="line">            Name "HeightField RenderPass"</span><br><span class="line"></span><br><span class="line">            Cull Off</span><br><span class="line">            HLSLPROGRAM</span><br><span class="line">            <span class="meta">#pragma enable_d3d11_debug_symbols</span></span><br><span class="line">            <span class="meta">#pragma vertex vert</span></span><br><span class="line">            <span class="meta">#pragma fragment frag</span></span><br><span class="line"></span><br><span class="line">            <span class="meta">#include "./TerrianCore.hlsl"</span></span><br><span class="line">            <span class="meta">#include "Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl"</span></span><br><span class="line"></span><br><span class="line">            <span class="meta">#pragma multi_compile_local _ _DEBUG</span></span><br><span class="line">            <span class="meta">#pragma multi_compile_local _ _USE_LOCAL_UV</span></span><br><span class="line">            <span class="meta">#pragma multi_compile_local _ _SHOW_UV</span></span><br><span class="line"></span><br><span class="line">            TEXTURE2D_ARRAY(_heightFieldTexture2DArray);</span><br><span class="line">            SAMPLER(sampler_heightFieldTexture2DArray);</span><br><span class="line"></span><br><span class="line">            TEXTURE2D(_MainTex);</span><br><span class="line">            SAMPLER(sampler_MainTex);</span><br><span class="line"></span><br><span class="line">            CBUFFER_START(UnityPerDraw)</span><br><span class="line"></span><br><span class="line">            CBUFFER_END</span><br><span class="line"></span><br><span class="line">            struct Attributes</span><br><span class="line">            {</span><br><span class="line">                float4 positionOS : POSITION;</span><br><span class="line">                float2 texcoord : TEXCOORD0;</span><br><span class="line">                <span class="type">uint</span> instanceId : SV_InstanceID;</span><br><span class="line">            };</span><br><span class="line"></span><br><span class="line">            struct Varyings</span><br><span class="line">            {</span><br><span class="line">                float4 vertex : SV_POSITION;</span><br><span class="line">                float2 texcoord : TEXCOORD0;</span><br><span class="line">            };</span><br><span class="line"></span><br><span class="line">            StructuredBuffer&lt;HeightField_PatchInfo&gt; heightField_PatchInfoBuffer;</span><br><span class="line"></span><br><span class="line">            Varyings vert(Attributes input)</span><br><span class="line">            {</span><br><span class="line">                Varyings output;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">const</span> HeightField_PatchInfo item = heightField_PatchInfoBuffer[input.instanceId];</span><br><span class="line"></span><br><span class="line">                float4 positionOS = input.positionOS;</span><br><span class="line"></span><br><span class="line">                <span class="type">uint</span> scale = <span class="built_in">pow</span>(<span class="number">2</span>, item.lod);</span><br><span class="line">                <span class="type">uint</span> nodeSize = scale * <span class="number">64</span>;</span><br><span class="line">                <span class="type">uint</span> patchSize = nodeSize / <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 缩放</span></span><br><span class="line">                positionOS.xz *= scale;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 先将patch转换到node空间</span></span><br><span class="line">                <span class="comment">// 为了统一shader运算，将坐标系转换到中心点</span></span><br><span class="line">                <span class="comment">// 因为thread count xy为 8 * 8，所以要转换成中心点的话，得 -4 得到左下角坐标，再 +0.5 得到中心点坐标</span></span><br><span class="line">                <span class="keyword">const</span> float2 localXZ_NodeSpace = positionOS.xz + ((item.indexXZ_Local - <span class="number">4</span> + <span class="number">0.5</span>) * patchSize);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 世界空间平移 + 节点空间偏移</span></span><br><span class="line">                positionOS.xz = localXZ_NodeSpace + nodeSize / <span class="number">2</span> + item.belongToNodePosXZ_World;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// uv目标为128 * 128的高度图</span></span><br><span class="line">                float2 heightFieldUV = (input.positionOS.xz * scale + (patchSize / <span class="number">2</span>) + (item.indexXZ_Local *</span><br><span class="line">                    patchSize)) / ((nodeSize));</span><br><span class="line"></span><br><span class="line">                float4 hfColor = SAMPLE_TEXTURE2D_ARRAY_LOD(_heightFieldTexture2DArray,</span><br><span class="line">                                                            sampler_heightFieldTexture2DArray,</span><br><span class="line">                                                            heightFieldUV, item.textureArrayIndex, <span class="number">0</span>);</span><br><span class="line">                <span class="comment">// y投影，这里需要获取每个tile的最高高度和最低高度的差值</span></span><br><span class="line">                positionOS.y = hfColor.r * <span class="number">117.9315</span>f - <span class="number">18.2877</span>f;</span><br><span class="line"></span><br><span class="line">                output.vertex = TransformObjectToHClip(positionOS.xyz);</span><br><span class="line"></span><br><span class="line">                <span class="meta">#if _DEBUG &amp;&amp; _USE_LOCAL_UV</span></span><br><span class="line">                output.texcoord = input.texcoord;</span><br><span class="line">                <span class="meta">#else</span></span><br><span class="line">                <span class="comment">// UV适配缩放</span></span><br><span class="line">                output.texcoord = heightFieldUV;</span><br><span class="line">                <span class="meta">#endif</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> output;</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            float4 frag(Varyings input) : SV_Target</span><br><span class="line">            {</span><br><span class="line">                <span class="meta">#if _DEBUG &amp;&amp; _SHOW_UV</span></span><br><span class="line">                <span class="keyword">return</span> float4(input.texcoord.x, input.texcoord.y,<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">                <span class="meta">#else</span></span><br><span class="line">                <span class="keyword">return</span> SAMPLE_TEXTURE2D(_MainTex, sampler_MainTex, input.texcoord);</span><br><span class="line">                <span class="meta">#endif</span></span><br><span class="line">            }</span><br><span class="line">            ENDHLSL</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    CustomEditor "LWGUI.LWGUI"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>结果如下（为了方便排查问题，我已经将patch剔除去掉了）</p>
<p><img src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/202310292151413.png!webp" alt="全patch绘制，未进行裁剪" loading='lazy'></p>
<p>emm，问题似乎有点多，我们一个个解决</p>
<h2 id="解决问题">解决问题</h2>
<h3 id="uv-1时的边缘走样">uv = 1时的边缘走样</h3>
<p>首先猜测是UV溢出导致采样到uv = 0的纹素，通过对比发现确实如此</p>
<p><img src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/202310292221551.png" alt="利用平面对比node的uv=0和uv=1的高度，发现完全一致" loading='lazy'></p>
<p>为了使问题更加明显，我特意畸化了一个纹理的uv = 1的边缘处：</p>
<p><img src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/202310292223430.png" alt="可以看到，ps的采样是对的，但我们在vs的采样失败了" loading='lazy'></p>
<p>我们输出UV看下：</p>
<p><img src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/202310292225881.png!webp" alt="i非常正确，没有任何问题" loading='lazy'></p>
<p>看起来完全没有问题，考虑过需要手动计算UV偏移矫正（参考文末的UV坐标相关文章），但发现UV=0的地方会溢出。。。</p>
<p>没办法了，截帧看下：</p>
<p>uv边界难以捉摸，vs中uv = 1的地方默认是截至0.99998，而我们手动计算出的uv是会=1的，所以就溢出到了uv=0的地方</p>
<p><img src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/202310292227657.png!webp" alt="可以看到" loading='lazy'></p>
<p>到头来是因为我们算的太对，违背了驱动规则，其底层原理应该和 <a target="_blank" rel="noopener" href="https://www.reedbeta.com/blog/texture-gathers-and-coordinate-precision/">texture-gathers-and-coordinate-precision</a> 意思差不多（但也仅仅是意思差不多，其实不是一回事，文章里是双线性插值时主动处理临界值，而本文是不带滤波的UV溢出和驱动层舍入规则冲突），驱动层会对UV进行8位舍入</p>
<p><img src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/202403062058084.png" alt="image-20240306205832032" loading='lazy'></p>
<p>解决方式也很简单，将Texture2DArray的wrapMode设置为Clamp即可</p>
<h3 id="不同Node边缘不匹配问题-地形过于锐利问题">不同Node边缘不匹配问题 &amp;&amp; 地形过于锐利问题</h3>
<p>通过下面这张图我们可以看到有些边缘是接不上的</p>
<p><img src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/202310292229296.png!webp" alt="QQ截图20231029120622" loading='lazy'></p>
<p>在高度变化剧烈的区域更为明显</p>
<p><img src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/202310292231782.png!webp" alt="QQ截图20231029121032" loading='lazy'></p>
<p>这是纯warframe视图</p>
<p><img src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/202310292230920.png!webp" alt="QQ截图20231029120644" loading='lazy'></p>
<p>而且似乎。。。都是中间少了一个grid的信息，可能还不够明显，我们将纹理导入Houdini直接看结果</p>
<p>左边是原始渲染结果，右边是拼合结果，可以看出就是少了一条grid的信息导致的</p>
<p><img src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/202310292231244.png!webp" alt="QQ截图20231029161319" loading='lazy'></p>
<p>找到问题根源，解决方案就很简单了，我们在导出高度图的时候额外导出1一个体素大小即可，这应该是Houdini的heightField体素计算的底层规则，会预留一些体素大小来进行拼接</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">output_node.parm(<span class="string">"tile_overlapx"</span>).<span class="built_in">set</span>(<span class="string">"1"</span>)</span><br><span class="line">output_node.parm(<span class="string">"tile_overlapy"</span>).<span class="built_in">set</span>(<span class="string">"1"</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>重新从Houdini导出高度图，然后导入Unity，问题解决</p>
<p><img src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/202310292234756.png!webp" alt="fixed" loading='lazy'></p>
<p>然后<code>地形过于尖锐是因为我一开始开启了BC4压缩优化，而BC4是有损压缩，导致高度图数据丢失，将压缩格式改回R16即可解决</code>，当时还去RenderDoc对比了下出现接缝的两个tile数值，发现从贴图采样出的数值已经不一样了，就想到这个原因</p>
<p><img src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/202403020043055.png" alt="image-20240302004316927" loading='lazy'></p>
<p>最后加上Patch的剔除</p>
<p><img src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/202403020046066.png" alt="image-20240302004631916" loading='lazy'></p>
<p>好了，到目前为止，我们的地形已经可以渲染出来了，但其实有个不容忽视的问题，那就是我们的四叉树是没有处理高度信息的</p>
<p>有些朋友看到这可能有些迷惑了，这不整挺好吗，没看出啥问题？但实际上我们现在相机高度为0，和没有高度信息的四叉树是对齐的，然而地形高度已经是几十米了，也就是说有相当一部分的地块理应被剔除但被渲染了</p>
<p><img src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/202311020008000.png!webp" alt="image-20231102000837831" loading='lazy'></p>
<p>当我们尝试移动相机高度时，地块剔除问题依旧存在，从下图可以看到，原本应该被渲染的地块被剔除掉了</p>
<p><img src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/202311020009289.png!webp" alt="image-20231102000924150" loading='lazy'></p>
<p>这是因为，我们的四叉树是构建在y高度为0上的，这样会有个很严重的问题，一旦相机高度，角度发生变化，我们就无法在不知道y轴高度的情况下进行正确的裁剪，试想一下，相机高度为100和1的时候，往同一方向看，看到的地块应当是完全不一样的，但如果我们没有y轴信息，那么就没法正确获取这个差异性，从而无法正确裁剪，上面截图中被误剔除掉的地块也是这个原因</p>
<p><img src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/202311020000123.png" alt="image-20231102000042010" loading='lazy'></p>
<p>接下来我们需要解决这个问题，进入我们的地形渲染-二阶段</p>
<h1>二阶段预览</h1>
<p>到目前为止，我们的剔除分为两个阶段，CPU Node粒度的剔除，以及GPU Patch级别的剔除</p>
<p>我们世界是<code>20480*20480</code>的，以LOD为准导出每个node最低和最高信息的话</p>
<ul>
<li>LOD0级别数据大小为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mo stretchy="false">(</mo><mfrac><mn>20480</mn><mn>64</mn></mfrac><mo>×</mo><mn>8</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><mrow><mn>1024</mn><mo>×</mo><mn>1024</mn></mrow></mfrac><mo>=</mo><mn>6.25</mn><mi>M</mi><mi>B</mi></mrow><annotation encoding="application/x-tex">\frac{(\frac{20480}{64}\times8)^2}{1024\times1024} = 6.25 MB</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.5781em;vertical-align:-0.4033em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1747em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1024</span><span class="mbin mtight">×</span><span class="mord mtight">1024</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.5508em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8443em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">64</span></span></span></span><span style="top:-3.2255em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">20480</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span><span class="mbin mtight">×</span><span class="mord mtight">8</span><span class="mclose mtight"><span class="mclose mtight">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4033em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">6.25</span><span class="mord mathnormal" style="margin-right:0.05017em;">MB</span></span></span></span></li>
<li>LOD1级别数据大小为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mo stretchy="false">(</mo><mfrac><mn>20480</mn><mn>128</mn></mfrac><mo>×</mo><mn>8</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><mrow><mn>1024</mn><mo>×</mo><mn>1024</mn></mrow></mfrac><mo>=</mo><mn>1.5625</mn><mi>M</mi><mi>B</mi></mrow><annotation encoding="application/x-tex">\frac{(\frac{20480}{128}\times8)^2}{1024\times1024} = 1.5625 MB</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.5781em;vertical-align:-0.4033em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1747em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1024</span><span class="mbin mtight">×</span><span class="mord mtight">1024</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.5508em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8443em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">128</span></span></span></span><span style="top:-3.2255em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">20480</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span><span class="mbin mtight">×</span><span class="mord mtight">8</span><span class="mclose mtight"><span class="mclose mtight">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4033em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">1.5625</span><span class="mord mathnormal" style="margin-right:0.05017em;">MB</span></span></span></span></li>
<li>LOD2级别数据大小为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mo stretchy="false">(</mo><mfrac><mn>20480</mn><mn>256</mn></mfrac><mo>×</mo><mn>8</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><mrow><mn>1024</mn><mo>×</mo><mn>1024</mn></mrow></mfrac><mo>=</mo><mn>0.390</mn><mi>M</mi><mi>B</mi></mrow><annotation encoding="application/x-tex">\frac{(\frac{20480}{256}\times8)^2}{1024\times1024} = 0.390 MB</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.5781em;vertical-align:-0.4033em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1747em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1024</span><span class="mbin mtight">×</span><span class="mord mtight">1024</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.5508em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8443em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">256</span></span></span></span><span style="top:-3.2255em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">20480</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span><span class="mbin mtight">×</span><span class="mord mtight">8</span><span class="mclose mtight"><span class="mclose mtight">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4033em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">0.390</span><span class="mord mathnormal" style="margin-right:0.05017em;">MB</span></span></span></span></li>
<li>LOD3级别数据大小为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mo stretchy="false">(</mo><mfrac><mn>20480</mn><mn>512</mn></mfrac><mo>×</mo><mn>8</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><mrow><mn>1024</mn><mo>×</mo><mn>1024</mn></mrow></mfrac><mo>=</mo><mn>0.1</mn><mi>M</mi><mi>B</mi></mrow><annotation encoding="application/x-tex">\frac{(\frac{20480}{512}\times8)^2}{1024\times1024} = 0.1 MB</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.5781em;vertical-align:-0.4033em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1747em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1024</span><span class="mbin mtight">×</span><span class="mord mtight">1024</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.5508em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8443em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">512</span></span></span></span><span style="top:-3.2255em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">20480</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span><span class="mbin mtight">×</span><span class="mord mtight">8</span><span class="mclose mtight"><span class="mclose mtight">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4033em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">0.1</span><span class="mord mathnormal" style="margin-right:0.05017em;">MB</span></span></span></span></li>
<li>LOD4级别数据大小为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mo stretchy="false">(</mo><mfrac><mn>20480</mn><mn>1024</mn></mfrac><mo>×</mo><mn>8</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><mrow><mn>1024</mn><mo>×</mo><mn>1024</mn></mrow></mfrac><mo>=</mo><mn>0.02</mn><mi>M</mi><mi>B</mi></mrow><annotation encoding="application/x-tex">\frac{(\frac{20480}{1024}\times8)^2}{1024\times1024} = 0.02 MB</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.5781em;vertical-align:-0.4033em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1747em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1024</span><span class="mbin mtight">×</span><span class="mord mtight">1024</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.5508em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8443em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">1024</span></span></span></span><span style="top:-3.2255em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">20480</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span><span class="mbin mtight">×</span><span class="mord mtight">8</span><span class="mclose mtight"><span class="mclose mtight">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4033em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">0.02</span><span class="mord mathnormal" style="margin-right:0.05017em;">MB</span></span></span></span></li>
<li>LOD5级别数据大小为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mo stretchy="false">(</mo><mfrac><mn>20480</mn><mn>2048</mn></mfrac><mo>×</mo><mn>8</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><mrow><mn>1024</mn><mo>×</mo><mn>1024</mn></mrow></mfrac><mo>=</mo><mn>0.004</mn><mi>M</mi><mi>B</mi></mrow><annotation encoding="application/x-tex">\frac{(\frac{20480}{2048}\times8)^2}{1024\times1024} = 0.004 MB</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.5781em;vertical-align:-0.4033em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1747em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1024</span><span class="mbin mtight">×</span><span class="mord mtight">1024</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.5508em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8443em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">2048</span></span></span></span><span style="top:-3.2255em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">20480</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span><span class="mbin mtight">×</span><span class="mord mtight">8</span><span class="mclose mtight"><span class="mclose mtight">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4033em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">0.004</span><span class="mord mathnormal" style="margin-right:0.05017em;">MB</span></span></span></span></li>
</ul>
<p>总共约8MB的数据，<strong>我们使用二进制存储，并将数据填入四叉树节点中，流送到GPU</strong></p>
<iframe id="embed_dom" name="embed_dom" frameborder="0" style="width:100%; height:500px;" src="https://www.processon.com/embed/6546439854338f0b199c5cee"></iframe>
<h1>CPU（二阶段）</h1>
<h2 id="数据准备">数据准备</h2>
<p>既然我们所有地形数据都来自于Houdini，那我们干脆把这些高度数据也经由Houdini导出吧，直接在PDG最后阶段加入HDA Processor指定相应HDA即可</p>
<h3 id="Node级别的高度信息">Node级别的高度信息</h3>
<p>因为CPU裁剪的粒度以Node为单位，所以我们要输出Node级别的高度信息，并且每个LOD级别都要输出</p>
<p>最终需要将高度数据随着TerrianNode传入GPU</p>
<figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> HeightField_NodeInfo</span><br><span class="line">{</span><br><span class="line">    <span class="comment">// 世界空间坐标，（左下角）</span></span><br><span class="line">    float2 posXZ_World;</span><br><span class="line">    <span class="comment">// 所属高度图的最高，最低值</span></span><br><span class="line">    float2 height_Min_Max;</span><br><span class="line">    <span class="built_in">uint</span> lod;</span><br><span class="line">    <span class="built_in">uint</span> textureArrayIndex;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<h1>GPU（二阶段）</h1>
<p>最后在Compute Shader直接拿高度信息进行裁剪即可</p>
<figure class="highlight glsl"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">float3 boundMax = float3(posXZ_WS.x + half_xz, height_field_node_info.height_Min_Max.y, posXZ_WS.y + half_xz);</span><br><span class="line">float3 boundMin = float3(posXZ_WS.x - half_xz, height_field_node_info.height_Min_Max.x, posXZ_WS.y - half_xz);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (FrustumCullBound(boundMin, boundMax, frustumPlanes))</span><br><span class="line">{</span><br><span class="line">	heightField_PatchInfoBuffer.Append(height_field_patch_info);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>效果：</p>
<p><img src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/202403061926085.png" alt="image-20240306192603928" loading='lazy'></p>
<p>可以看到基本上达到了较为精准的剔除，之所以镜头下方多出了一点，是因为我们采用保守剔除的方式，因为我们只记录的每个tile的最高和最低值，没法精确到每个patch的高度</p>
<h1>后记</h1>
<p>其实如果是第一人称或者第三人称过肩视角，地形还有很多需要处理的事情，例如hiz遮挡剔除，不同lod之间的接缝修复，back face剔除等，但ProjectS大多数时候为俯视角，所以就不做这些得不偿失的需求了</p>
<h1>参考</h1>
<p><a target="_blank" rel="noopener" href="https://huailiang.github.io/blog/2019/texturearray/">TextureArray用法</a></p>
<p><a target="_blank" rel="noopener" href="https://pvigier.github.io/2019/08/04/quadtree-collision-detection.html">Quadtree and Collision Detection</a></p>
<p><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/31064727/answer/3161076809">uv坐标是什么?</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/direct3d9/directly-mapping-texels-to-pixels">directly-mapping-texels-to-pixels </a></p>
<p><a target="_blank" rel="noopener" href="https://www.reedbeta.com/blog/texture-gathers-and-coordinate-precision/">Texture Gathers and Coordinate Precision</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/lijundacom/LeoGPUDriven">https://github.com/lijundacom/LeoGPUDriven</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="www.lfzxb.top">烟雨迷离半世殇</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://www.lfzxb.top/projects-terrian-rendering/">https://www.lfzxb.top/projects-terrian-rendering/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://www.lfzxb.top" target="_blank">登峰造极者，殊途亦同归。</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/GPU-Driven/">GPU Driven</a><a class="post-meta__tags" href="/tags/%E5%9B%BE%E5%BD%A2%E6%B8%B2%E6%9F%93/">图形渲染</a><a class="post-meta__tags" href="/tags/PCG/">PCG</a><a class="post-meta__tags" href="/tags/Houdini/">Houdini</a><a class="post-meta__tags" href="/tags/Hi-zBuffer/">Hi-zBuffer</a><a class="post-meta__tags" href="/tags/RVT/">RVT</a></div><div class="post-share"><div class="social-share" data-image="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/202403020046066.png!webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer=""></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/2019/04/QQ截图20190430175314.png!webp" target="_blank"><img class="post-qr-code-img" src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/2019/04/QQ截图20190430175314.png!webp" alt="微信" loading='lazy'></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/2019/04/QQ截图20190430175304.png!webp" target="_blank"><img class="post-qr-code-img" src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/2019/04/QQ截图20190430175304.png!webp" alt="支付宝" loading='lazy'></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><div class="ads-wrap"><ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-7235595771604497" data-ad-slot="9104433828"></ins><script> (adsbygoogle = window.adsbygoogle || []).push({});</script></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/houdini-heightfield-manual/" title="Houdini HeightField手册"><img class="cover" src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/202307222334574.png!webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post" loading='lazy'><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Houdini HeightField手册</div></div><div class="info-2"><div class="info-item-1">Houdini中HeightField相关节点在地形生成中占据了非常重要的地位，虽然可以在Houdini里右键节点-Helper查看详细的官方文档，但未对整个HeightField系统有一个宏观认识的情况下，也不知道要用哪些节点。所以单独开篇文章来记录常用的HeightField几点以及使用心得 （但HeightField手册又何必只是HeightField手册^ ^        _） 基础高度场操作 HeightField 基础的高度场节点，用于指定高度场的大小，细分/模拟粒度等基础信息 这个节点用于生成两个 2D volume 基元：height体积和mask体积，具有给定的分辨率和初始值，这些基元可以由其他地形节点进行修改。 height体积 是一个 2D 网格，表示地图上每个点的地形距离地面平面的距离（这些值可以为负）。 mask体积 可以用作其他地形工具的“mask”输入。它指定了地形节点的效果应该应用于哪些区域：mask值为 0 的区域不受节点影响，掩模值为 1 的区域完全受节点影响。地形节点允许你绘制mask或从地形信息中生成mask（例如，阴影落在哪里，或低于某...</div></div></div></a><a class="pagination-related" href="/diablo_4/" title="《暗黑破坏神4》游玩有感"><img class="cover" src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/202306120010941.png!webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post" loading='lazy'><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">《暗黑破坏神4》游玩有感</div></div><div class="info-2"><div class="info-item-1">还是最喜欢这个拜念三归，地狱的压迫感拉满！   最近玩了暗黑破坏神4，感触颇多 技能Build 技能Build其实没什么好说的，依旧是基础技能+符文系统完善Build，但相较于恐怖黎明的星座，流放之路的技能树+升华，暗黑4的理解成本和玩家友好程度更加出色。它的巅峰系统居然是可以旋转的。。。，这意味着玩家可以不用太过拘泥于设计好的巅峰树，而是能最大限度地按照自己的意愿去体验整个系统 之前在内测时体验过所有角色，感觉到暗黑4是想让玩家尽可能的把手参与到战斗中，而不是进个图，几个buff一加，技能一开，直接跑跑跑完事，虽然说增加了一些上手难度，但确实是能让玩家更用心的去体验战斗的刺激。很合我胃口，毕竟我玩剑圣的，哈哈（顺带吐槽，狗曰的一如既往对平A近战不友好，各种暴毙 玩了这么多暗黑Like作品，技能流派来来回回就那么回事，什么双持+AOE剑圣，大风车，召唤平推流，万剑齐发。。。其实这类游戏发展到这种地步，Build上很难再做出让人眼前一亮的设计了，就像LOL最近新出的英雄，就是基于各种技能元素，缝来缝去，然后得到一个全新风格的英雄，不是说不好，反而是相当健康的一种发展模式，能让玩家在...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/projects-gpu-driven/" title="ProjectS中的GPU Driven"><img class="cover" src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/202509232351560.webp" alt="cover" loading='lazy'><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2023-05-22</div><div class="info-item-2">ProjectS中的GPU Driven</div></div><div class="info-2"><div class="info-item-1">架构 前阵子敲定了ProjectS GI方案的大体架构，但只对着那几个Cube可看不出落地效果，也没法做针对性的优化，所以准备启动地形相关的开发工作 立项之时就考虑到美术成本问题，所以采用程序化生成作为构建ProjectS世界的主要手段，程序化生成意味着大量重复instance和大地形，这时候就得利用GPU Driven来作为整个PCG系统的底层支柱之一了，我们常说的GPU Driven包括以下几个方面 地形渲染 制作  Houdini 生成高度图+Mask VS 直接生成Mesh  Houdini生成高度图+Mask方案对于Houdini来说更加轻量，不需要处理地形Mesh 直接生成最终Mesh可以离线对Mesh做处理，包括岩壁重展UV，LOD计算等 但对于ProjectS来说，没有太特殊的需求对Mesh做处理，一些岩壁拉伸问题也可以通过处理贴图渲染进行解决，最终选用高度图方案    渲染  DrawInstanceIndirectly通用Quad Mesh + LOD + 高度图采样 实现地形渲染 VS Mesh Cluster Rendering + LOD 实现地形渲染 ...</div></div></div></a><a class="pagination-related" href="/projects-terrian-shading/" title="ProjectS中的地形系统-Terrian Shading（Material Id）"><img class="cover" src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/202410061425447.gif!webp" alt="cover" loading='lazy'><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-10-05</div><div class="info-item-2">ProjectS中的地形系统-Terrian Shading（Material Id）</div></div><div class="info-2"><div class="info-item-1">地形系统思路来自 ProjectS中的GPU Driven 前言 再来回顾下传统地表材质与我们定好的方案之间的对比：  传统Weight Blend方案：通过纹理 + Mask图实现多纹理混合渲染  每多一张纹理贴图，就要多一份遮罩数据。 由于每点的mask总和为1，所以改变一层需要动到其他所有层的数据，耦合度太高，不方面大规模修改迭代。 编辑器在处理edit layer时，由于需要全局的归一化操作，所以会让上层的layer表现非常奇怪。 随着edit layer的增加，内存和操作延时也会是个问题。 渲染时由于每个地块使用的weightmap各不相同，所以加大了合批处理的难度。   Material Id方案：确保每个点只有一种纹理贴图的情况下，通过一张Material Id图控制，最后通过双线性插值混合平滑，这里的材质不是指材质球，而是指一个数据结构，其中包含材质参数，贴图索引以及其他信息  优点是这张MaterialId，它相当于一个间接的索引，每个值表示一张纹理图。8位的单通道materialID图就足以支持超过200种纹理图。它的大小可控，不会随着纹理数量的增加而增加。同...</div></div></div></a><a class="pagination-related" href="/projects-terrian-pcg/" title="ProjectS中的地形系统-Procedural Content Generation（PCG）"><img class="cover" src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/202308310012616.png!webp" alt="cover" loading='lazy'><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-06-23</div><div class="info-item-2">ProjectS中的地形系统-Procedural Content Generation（PCG）</div></div><div class="info-2"><div class="info-item-1">本篇文章是对ProjectS中地形PCG模块的总结，可能需要一些前置知识，可以前往本文的 参考 部分进行相关引用 先明确下项目需求  20km x 20km的世界大小 大多数地貌为起伏幅度较小的平原 需要分tile编辑，预览 需要导出LOD高度图 支持植被和物件Instance的纹理生成和手工修改 需要一个工具统筹管理整个PCG管线，并实时查看每一步的结果  最终选择Houdini作为目标软件，因为Houdini作为一款相当成熟的PCG向的DCC软件，提供了相当多地形创建，编辑和工作流工具，应对我这个个人项目的简单地形PCG工作自然不成问题 项目概览 项目结构如下：   terrian_pdg：地形PDG模块，组织整个地形的PCG流程 terrian_sop：地形PCG中用到的所有SOP集合，大部分都导出成了HDA，供PDG使用  PDG流程 我在学习和解构一个对象的时候习惯从宏观看起，大概掌握每个环节的功能，有个全局的概念，再看具体细节的时候不会有一头雾水的感觉，所以我们从PDG开始看起  整个流程非常的直观  创建地形骨架 拆分地形 根据地形编号查找hda文件，如果存在则进行...</div></div></div></a><a class="pagination-related" href="/houdini-heightfield-manual/" title="Houdini HeightField手册"><img class="cover" src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/202307222334574.png!webp" alt="cover" loading='lazy'><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-06-19</div><div class="info-item-2">Houdini HeightField手册</div></div><div class="info-2"><div class="info-item-1">Houdini中HeightField相关节点在地形生成中占据了非常重要的地位，虽然可以在Houdini里右键节点-Helper查看详细的官方文档，但未对整个HeightField系统有一个宏观认识的情况下，也不知道要用哪些节点。所以单独开篇文章来记录常用的HeightField几点以及使用心得 （但HeightField手册又何必只是HeightField手册^ ^        _） 基础高度场操作 HeightField 基础的高度场节点，用于指定高度场的大小，细分/模拟粒度等基础信息 这个节点用于生成两个 2D volume 基元：height体积和mask体积，具有给定的分辨率和初始值，这些基元可以由其他地形节点进行修改。 height体积 是一个 2D 网格，表示地图上每个点的地形距离地面平面的距离（这些值可以为负）。 mask体积 可以用作其他地形工具的“mask”输入。它指定了地形节点的效果应该应用于哪些区域：mask值为 0 的区域不受节点影响，掩模值为 1 的区域完全受节点影响。地形节点允许你绘制mask或从地形信息中生成mask（例如，阴影落在哪里，或低于某...</div></div></div></a><a class="pagination-related" href="/houdini-procedural-dependency-graph-manual/" title="Houdini Procedural Dependency Graph（PDG）手册"><img class="cover" src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/202308102330018.png!webp" alt="cover" loading='lazy'><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-06-19</div><div class="info-item-2">Houdini Procedural Dependency Graph（PDG）手册</div></div><div class="info-2"><div class="info-item-1">在使用PDG的时候，对于一个新的节点，总有一种云里雾里的感觉，看官方文档也是迷迷糊糊的，还好基本上每个节点都有提供相应的Sample，并标注了注意事项。 本篇就记录下PDG的一些重要节点，以及使用过程中的注意点 节点 Wedge 主要有以下几个作用   创建Work Item，驱动PDG   用于生成Attribute（可以多个），对于Wedge的Attribute，可以在整个TOP中通过@xxx来引用，当然，在和常规字符混排的的时候，需要加反向单引号例如： 1$HIP/geo/boxsphere_`@wedgeindex`.bgeo.sc   强制覆写某个参数，可以理解为非侵入式的一种数据注入方案   多个Wedege之前关系为嵌套关系，比如WedgeA的WedgeCount为2，WedgeB的WedgeCount为3，当B连接到A的出口，那么B将会输出2x3 = 6个WorkItem Partition by Index 它做的事情非常简单，就是将多个WorkItem按照index和一定的规则merge成一个WorkItem，每个WorkItem的index可以通过双击查看 ...</div></div></div></a><a class="pagination-related" href="/adaptive-virtual-texture-rendering-in-far-cry-4/" title="Adaptive Virtual Texture Rendering in Far Cry 4"><img class="cover" src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2025/image-20250130155113039.png" alt="cover" loading='lazy'><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2025-01-31</div><div class="info-item-2">Adaptive Virtual Texture Rendering in Far Cry 4</div></div><div class="info-2"><div class="info-item-1">差不多该动手实现ProjectS中地形的RVT了，所以整理一波学习资料，依旧是以FarCry为主体 注意本文中同样的词汇在不同上下文中有不同的意思，以RVT为例，在Procedural Virtual Textures部分，RVT代表Procedural Virtual Textures，但在Adaptive Virtual Textures部分，RVT则代表Adaptive Virtual Textures，基于历史发展，简单排列下术语  VT：Virtual Texture，包含SVT（Mega-Texture），RVT（Procedural Virtual Textures，经典RVT），AVT（Adaptive Virtual Textures，Far Cry4提出的改良版RVT） Page：VT的其中一部分，其实叫Tile会更加合理一些，可以理解为VT是由一个个Page组成的，也是我们渲染到RT上的最小单位 Indirection Texture：VT和真实RT映射表，也叫Page Table Physical Texture Cache：最终用于渲染的的RenderT...</div></div></div></a></div></div><hr class="custom-hr"><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#postchat_postcontent"><span class="toc-number">1.</span> <span class="toc-text">架构</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#postchat_postcontent"><span class="toc-number">2.</span> <span class="toc-text">资源准备</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Patch"><span class="toc-number">2.1.</span> <span class="toc-text">Patch</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Height-Texture"><span class="toc-number">2.2.</span> <span class="toc-text">Height Texture</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#postchat_postcontent"><span class="toc-number">3.</span> <span class="toc-text">CPU（一阶段）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Terrian-Entity"><span class="toc-number">3.1.</span> <span class="toc-text">Terrian Entity</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#TerrianRenderComponent"><span class="toc-number">3.1.1.</span> <span class="toc-text">TerrianRenderComponent</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%9B%E5%8F%89%E6%A0%91%E6%9E%84%E9%80%A0"><span class="toc-number">3.1.1.1.</span> <span class="toc-text">四叉树构造</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B6%85%E5%A4%A7%E4%B8%96%E7%95%8C%E4%B8%8B%E7%9A%84%E5%8C%BA%E5%9F%9F%E6%80%A7%E5%9B%9B%E5%8F%89%E6%A0%91"><span class="toc-number">3.1.1.2.</span> <span class="toc-text">超大世界下的区域性四叉树</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8C%BA%E5%9F%9F%E6%80%A7%E5%9B%9B%E5%8F%89%E6%A0%91%E7%A7%BB%E5%8A%A8%E8%A7%A6%E5%8F%91%E6%B5%81%E5%BC%8F"><span class="toc-number">3.1.1.3.</span> <span class="toc-text">区域性四叉树移动触发流式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%96%E7%95%8C%E5%8E%9F%E7%82%B9%E4%B8%8ENode%E5%B8%83%E5%B1%80"><span class="toc-number">3.1.1.4.</span> <span class="toc-text">世界原点与Node布局</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Node%E5%86%85%E5%AE%B9"><span class="toc-number">3.1.1.5.</span> <span class="toc-text">Node内容</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%9B%E5%8F%89%E6%A0%91%E5%89%94%E9%99%A4"><span class="toc-number">3.1.1.6.</span> <span class="toc-text">四叉树剔除</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TerrianHeightFieldComponent"><span class="toc-number">3.1.2.</span> <span class="toc-text">TerrianHeightFieldComponent</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%81%E5%BC%8F%E5%8A%A0%E8%BD%BD"><span class="toc-number">3.1.2.1.</span> <span class="toc-text">流式加载</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#postchat_postcontent"><span class="toc-number">4.</span> <span class="toc-text">GPU（一阶段）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#HeightField-RenderFeature"><span class="toc-number">4.1.</span> <span class="toc-text">HeightField RenderFeature</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Patch%E6%9E%84%E5%BB%BA-%E5%89%94%E9%99%A4"><span class="toc-number">4.1.1.</span> <span class="toc-text">Patch构建&amp;&amp;剔除</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AB%98%E5%BA%A6%E5%9B%BE%E9%87%87%E6%A0%B7"><span class="toc-number">4.1.2.</span> <span class="toc-text">高度图采样</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E9%97%AE%E9%A2%98"><span class="toc-number">4.2.</span> <span class="toc-text">解决问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#uv-1%E6%97%B6%E7%9A%84%E8%BE%B9%E7%BC%98%E8%B5%B0%E6%A0%B7"><span class="toc-number">4.2.1.</span> <span class="toc-text">uv = 1时的边缘走样</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E5%90%8CNode%E8%BE%B9%E7%BC%98%E4%B8%8D%E5%8C%B9%E9%85%8D%E9%97%AE%E9%A2%98-%E5%9C%B0%E5%BD%A2%E8%BF%87%E4%BA%8E%E9%94%90%E5%88%A9%E9%97%AE%E9%A2%98"><span class="toc-number">4.2.2.</span> <span class="toc-text">不同Node边缘不匹配问题 &amp;&amp; 地形过于锐利问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#postchat_postcontent"><span class="toc-number">5.</span> <span class="toc-text">二阶段预览</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#postchat_postcontent"><span class="toc-number">6.</span> <span class="toc-text">CPU（二阶段）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%87%86%E5%A4%87"><span class="toc-number">6.1.</span> <span class="toc-text">数据准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Node%E7%BA%A7%E5%88%AB%E7%9A%84%E9%AB%98%E5%BA%A6%E4%BF%A1%E6%81%AF"><span class="toc-number">6.1.1.</span> <span class="toc-text">Node级别的高度信息</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#postchat_postcontent"><span class="toc-number">7.</span> <span class="toc-text">GPU（二阶段）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#postchat_postcontent"><span class="toc-number">8.</span> <span class="toc-text">后记</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#postchat_postcontent"><span class="toc-number">9.</span> <span class="toc-text">参考</span></a></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url(https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/20210912135042.png!webp);"><div class="footer-other"><div class="footer-copyright"><span class="copyright">©&nbsp;2025 - 2026 By 烟雨迷离半世殇</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.0</a></span></div><div class="footer_custom_text">2018-2025 lfzxb.top版权所有<br><span id="realtime_duration"></span><br><a href="https://beian.miit.gov.cn" target="_blank">苏ICP备19003389号-1</a><br><img src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/blog2021/20210912135040.png!webp" alt="公网安备字" loading='lazy'><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=32032102000159" target="_blank">苏公网安备 32032102000159号</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="fluid-control-btn" type="button" title="流体模拟控制台"><i class="fas fa-water"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(async () => {
  const showKatex = () => {
    document.querySelectorAll('#article-container .katex').forEach(el => el.classList.add('katex-show'))
  }

  if (!window.katex_js_css) {
    window.katex_js_css = true
    await btf.getCSS('https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css')
    if (true) {
      await btf.getScript('https://cdn.jsdelivr.net/npm/katex/dist/contrib/copy-tex.min.js')
    }
  }

  showKatex()
})()</script><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const commentCount = n => {
    const isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
    if (isCommentCount) {
      isCommentCount.textContent= n
    }
  }

  const initGitalk = (el, path) => {
    if (isShuoshuo) {
      window.shuoshuoComment.destroyGitalk = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }

    const gitalk = new Gitalk({
      clientID: '508db6cacf197b7363d1',
      clientSecret: '2882a0b135eaa72b3ab256e37249c50733ce9e91',
      repo: 'wqaetly',
      owner: 'wqaetly',
      admin: ['wqaetly'],
      updateCountCallback: commentCount,
      proxy: "https://strong-caramel-969805.netlify.app/github_access_token",
      ...option,
      id: isShuoshuo ? path : (option && option.id) || 'ecfac6aa1eae6e4fe27b40e3c104a144'
    })

    gitalk.render('gitalk-container')
  }

  const loadGitalk = async(el, path) => {
    if (typeof Gitalk === 'function') initGitalk(el, path)
    else {
      await btf.getCSS('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css')
      await btf.getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js')
      initGitalk(el, path)
    }
  }

  if (isShuoshuo) {
    'Gitalk' === 'Gitalk'
      ? window.shuoshuoComment = { loadComment: loadGitalk }
      : window.loadOtherComment = loadGitalk
    return
  }

  if ('Gitalk' === 'Gitalk' || !false) {
    if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
    else loadGitalk()
  } else {
    window.loadOtherComment = loadGitalk
  }
})()</script></div><script src="https://cdn.jsdelivr.net/npm/dayjs/dayjs.min.js"></script><script src="https://cdn.jsdelivr.net/npm/dayjs/plugin/duration.min.js"></script><script src="/js/realtime.js"></script><script>window.FLUID_CONFIG={enable:true,mobile:false,z_index:-1,SIM_RESOLUTION:128,DYE_RESOLUTION:1024,DENSITY_DISSIPATION:1,VELOCITY_DISSIPATION:0.2,PRESSURE:0.8,PRESSURE_ITERATIONS:20,CURL:30,SPLAT_RADIUS:0.25,SPLAT_FORCE:6000,SHADING:true,COLORFUL:true,COLOR_UPDATE_SPEED:10,PAUSED:false,BACK_COLOR:{r:0,g:0,b:0},TRANSPARENT:false,BLOOM:true,BLOOM_ITERATIONS:8,BLOOM_RESOLUTION:256,BLOOM_INTENSITY:0.8,BLOOM_THRESHOLD:0.6,BLOOM_SOFT_KNEE:0.7,SUNRAYS:true,SUNRAYS_RESOLUTION:196,SUNRAYS_WEIGHT:1.0,interaction:{enable:true}};</script><script src="/js/fluid-simulation/dat.gui.min.js"></script><script src="/js/fluid-simulation/fluid-core.js"></script><script async="" data-pjax="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="docsearch-wrap"><div id="docsearch" style="display:none"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css/dist/style.min.css"><script src="https://cdn.jsdelivr.net/npm/@docsearch/js/dist/umd/index.min.js"></script><script>(() => {
  docsearch(Object.assign({
    appId: 'D3U85CARGJ',
    apiKey: '3edfc5bada9a140d5a4126085596f99c',
    indexName: 'blogsearch',
    container: '#docsearch',
    placeholder: '搜索文章',
  }, null))

  const handleClick = () => {
    document.querySelector('.DocSearch-Button').click()
  }

  const searchClickFn = () => {
    btf.addEventListenerPjax(document.querySelector('#search-button > .search'), 'click', handleClick)
  }

  searchClickFn()
  window.addEventListener('pjax:complete', searchClickFn)
})()</script></div></div>
    <link rel="stylesheet" href="https://ai.tianli0.top/static/public/postChatUser_summary.min.css">
    <script>
        let tianliGPT_key = 'S-TY6LYYCZMYV6UADE';
        let tianliGPT_postSelector = '#article-container';
        let tianliGPT_Title = '烟雨迷离半世殇（人机版）为您总结文章';
        let tianliGPT_postURL = 'https://www.lfzxb.top/*/';
        let tianliGPT_blacklist = '';
        let tianliGPT_wordLimit = '50000';
        let tianliGPT_typingAnimate = false;
        let tianliGPT_theme = 'menghuan';
        var postChatConfig = {
          backgroundColor: "#3e86f6",
          bottom: "16px",
          left: "16px",
          fill: "#FFFFFF",
          width: "44px",
          frameWidth: "375px",
          frameHeight: "600px",
          defaultInput: false,
          upLoadWeb: true,
          showInviteLink: true,
          userTitle: "烟雨迷离半世殇（人机版）为您服务",
          userDesc: "在下定知无不言",
          addButton: true,
          beginningText: "这篇文章介绍了",
          userIcon: "https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/AvatarAndBGs/33ec68b7fe1bb742.jpg!webp",
          userMode: "magic",
          defaultChatQuestions: ["你好","你是谁"],
          defaultSearchQuestions: ["视频压缩","设计"]
        };
    </script>
    <script data-postchat_key="S-TY6LYYCZMYV6UADE" src="https://ai.tianli0.top/static/public/postChatUser_summary.min.js"></script>
  </body></html>